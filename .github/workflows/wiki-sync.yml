name: Sync Docs to Wiki

on:
  push:
    branches:
      - main
    paths:
      - "docs/**/*.md"

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Wiki Repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.wiki.git" wiki

      - name: Configure Git
        run: |
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync Documentation
        run: |
          # docs ë””ë ‰í† ë¦¬ êµ¬ì¡° ê·¸ëŒ€ë¡œ wikië¡œ ë³µì‚¬ (.github ì œì™¸)
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            docs/ wiki/

      - name: Commit and Push Changes
        run: |
          cd wiki
          git add .

          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes to sync"
            exit 0
          fi

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¶”ì¶œ
          CHANGED_FILES=$(git diff --staged --name-only | head -5)
          FILE_COUNT=$(git diff --staged --name-only | wc -l)

          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          if [ "$FILE_COUNT" -le 5 ]; then
            git commit -m "docs: Wiki ìë™ ë™ê¸°í™”" \
                       -m "ë³€ê²½ëœ íŒŒì¼:" \
                       -m "$CHANGED_FILES" \
                       -m "" \
                       -m "Source: ${{ github.sha }}"
          else
            git commit -m "docs: Wiki ìë™ ë™ê¸°í™”" \
                       -m "${FILE_COUNT}ê°œ íŒŒì¼ ì—…ë°ì´íŠ¸" \
                       -m "" \
                       -m "Source: ${{ github.sha }}"
          fi
          git push origin master

      - name: Summary
        if: success()
        run: |
          echo "âœ… Wiki ë™ê¸°í™” ì™„ë£Œ"
          echo "ğŸ“„ Repository: ${{ github.repository }}"
          echo "ğŸ”— Wiki: https://github.com/${{ github.repository }}/wiki"
