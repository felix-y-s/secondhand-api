name: Sync Docs to Wiki

on:
  push:
    branches:
      - main
    paths:
      - "docs/**/*.md"

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Wiki Repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.wiki.git" wiki

      - name: Configure Git
        run: |
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync Documentation
        run: |
          # docs ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ë“¤ì„ í´ë” êµ¬ì¡° ë°˜ì˜í•˜ì—¬ wikië¡œ ë³µì‚¬
          # GitHub WikiëŠ” í´ë” êµ¬ì¡°ë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ íŒŒì¼ëª…ì— ê²½ë¡œë¥¼ í¬í•¨

          # ê¸°ì¡´ íŒŒì¼ ëª¨ë‘ ì‚­ì œ (Home.md ì œì™¸)
          cd wiki
          find . -name "*.md" ! -name "Home.md" -type f -delete
          cd ..

          # docs ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  .md íŒŒì¼ì„ ì°¾ì•„ì„œ ë³µì‚¬
          find docs -name "*.md" -type f | while read file; do
            # docs/ ì´í›„ì˜ ê²½ë¡œë¥¼ ì¶”ì¶œ (ì˜ˆ: guides/setup.md)
            relative_path="${file#docs/}"

            # ìŠ¬ë˜ì‹œë¥¼ í•˜ì´í”ˆìœ¼ë¡œ ë³€ê²½ (ì˜ˆ: guides-setup.md)
            wiki_filename=$(echo "$relative_path" | sed 's/\//-/g')

            # wiki ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
            cp "$file" "wiki/$wiki_filename"
          done

      - name: Commit and Push Changes
        run: |
          cd wiki
          git add .

          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes to sync"
            exit 0
          fi

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¶”ì¶œ
          CHANGED_FILES=$(git diff --staged --name-only | head -5)
          FILE_COUNT=$(git diff --staged --name-only | wc -l)

          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          if [ "$FILE_COUNT" -le 5 ]; then
            git commit -m "docs: Wiki ìë™ ë™ê¸°í™”" \
                       -m "ë³€ê²½ëœ íŒŒì¼:" \
                       -m "$CHANGED_FILES" \
                       -m "" \
                       -m "Source: ${{ github.sha }}"
          else
            git commit -m "docs: Wiki ìë™ ë™ê¸°í™”" \
                       -m "${FILE_COUNT}ê°œ íŒŒì¼ ì—…ë°ì´íŠ¸" \
                       -m "" \
                       -m "Source: ${{ github.sha }}"
          fi
          git push origin master

      - name: Summary
        if: success()
        run: |
          echo "âœ… Wiki ë™ê¸°í™” ì™„ë£Œ"
          echo "ğŸ“„ Repository: ${{ github.repository }}"
          echo "ğŸ”— Wiki: https://github.com/${{ github.repository }}/wiki"
