# Phase 4 ìµœì¢… ê°œë°œ ê³„íšì„œ (2025)

**ì‘ì„±ì¼**: 2025-11-18
**ëŒ€ìƒ ê¸°ê°„**: Week 11-14 (4ì£¼)
**í˜„ì¬ ìƒíƒœ**: Reviews ëª¨ë“ˆ ì™„ë£Œ â†’ Messages/Notifications êµ¬í˜„ í•„ìš”
**ëª©í‘œ**: í™•ì¥ ë„ë©”ì¸ ì™„ì„± + ì‹œìŠ¤í…œ í†µí•© ë° ìµœì í™”

---

## ğŸ“‹ í˜„í™© ë¶„ì„

### âœ… ì™„ë£Œëœ ëª¨ë“ˆ (Phase 1-3 + Reviews)

| ëª¨ë“ˆ | ìƒíƒœ | API ì—”ë“œí¬ì¸íŠ¸ | E2E í…ŒìŠ¤íŠ¸ | íŠ¹ì§• |
|------|------|---------------|-----------|------|
| Users | âœ… | 6ê°œ | 13ê°œ | JWT ì¸ì¦, RBAC |
| Products | âœ… | 8ê°œ | 21ê°œ | ê²€ìƒ‰, í•„í„°ë§, ìƒíƒœ ê´€ë¦¬ |
| Categories | âœ… | 5ê°œ | 11ê°œ | ê³„ì¸µ êµ¬ì¡° |
| Orders | âœ… | 8ê°œ | 17ê°œ | ìƒíƒœ ë¨¸ì‹  íŒ¨í„´ |
| **Reviews** | âœ… | 7ê°œ | ì˜ˆìƒ 10-15ê°œ | ì‹ ë¢°ë„ ì ìˆ˜ ì‹œìŠ¤í…œ |

**ì´ê³„**: 5ê°œ ëª¨ë“ˆ, 34ê°œ API, ì•½ 72-77ê°œ E2E í…ŒìŠ¤íŠ¸

### ğŸ—ï¸ Prisma ìŠ¤í‚¤ë§ˆ í˜„í™©

**ì™„ì „íˆ ì •ì˜ëœ ëª¨ë¸**:
- âœ… User (ì‹ ë¢°ë„ ì ìˆ˜ í•„ë“œ í¬í•¨)
- âœ… Category (ê³„ì¸µí˜• êµ¬ì¡°)
- âœ… Product (ìƒíƒœ, ìœ„ì¹˜ ì •ë³´)
- âœ… Order (ê²°ì œ, ë°°ì†¡ ì •ë³´)
- âœ… Review (í‰ì , ì´ë¯¸ì§€)
- âœ… ChatRoom (ì±„íŒ…ë°©)
- âœ… ChatRoomMember (ë©¤ë²„ ê´€ë¦¬)
- âœ… ChatMessage (ë©”ì‹œì§€ íƒ€ì…ë³„)
- âœ… Favorite (ì°œí•˜ê¸°)
- âœ… Notification (ì•Œë¦¼ íƒ€ì…ë³„)

**ìŠ¤í‚¤ë§ˆ ì™„ì„±ë„**: 100% âœ…

### ğŸ“¦ ì•„í‚¤í…ì²˜ í˜„í™©

**ì™„ì„±ëœ ì¸í”„ë¼**:
- âœ… NestJS 11.x + TypeScript 5.7.3
- âœ… PostgreSQL + Prisma ORM 6.2.0
- âœ… MongoDB (í™•ì¥ ë°ì´í„°)
- âœ… Redis (ìºì‹±)
- âœ… RabbitMQ (ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ)
- âœ… JWT ì¸ì¦ (Access + Refresh)
- âœ… RBAC ê¶Œí•œ ê´€ë¦¬
- âœ… Winston ë¡œê¹…
- âœ… Swagger API ë¬¸ì„œ
- âœ… Docker í™˜ê²½

**ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ ì™„ì„±ë„**: 100% âœ…

---

## ğŸ¯ Phase 4 ëª©í‘œ ë° ë²”ìœ„

### ìµœì¢… ëª©í‘œ

1. **Messages ëª¨ë“ˆ êµ¬í˜„**: êµ¬ë§¤ì-íŒë§¤ì 1:1 ì±„íŒ… ì‹œìŠ¤í…œ
2. **Notifications ëª¨ë“ˆ êµ¬í˜„**: í†µí•© ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬ì¶•
3. **Favorites ëª¨ë“ˆ êµ¬í˜„**: ì°œí•˜ê¸° ê¸°ëŠ¥ ì¶”ê°€
4. **ì‹œìŠ¤í…œ í†µí•©**: ì „ì²´ ë„ë©”ì¸ ê°„ ì´ë²¤íŠ¸ ì—°ë™
5. **ì½”ë“œ ë¦¬íŒ©í† ë§**: ê³µí†µ ë¡œì§ ì¶”ì¶œ ë° ìµœì í™”
6. **ë¬¸ì„œí™”**: API ë¬¸ì„œ ë° ê°œë°œ ê°€ì´ë“œ ìµœì‹ í™”

### ì„±ê³µ ì§€í‘œ

- âœ… 3ê°œ ë„ë©”ì¸ ëª¨ë“ˆ ì‹ ê·œ ì™„ì„± (Messages, Notifications, Favorites)
- âœ… 15-20ê°œ API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
- âœ… E2E í…ŒìŠ¤íŠ¸ 25-35ê°œ ì¶”ê°€ (ì´ 97-112ê°œ)
- âœ… ì „ì²´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼
- âœ… ì½”ë“œ ë¦¬íŒ©í† ë§ ì™„ë£Œ
- âœ… í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ

### ì‚°ì¶œë¬¼ ëª©ë¡

1. âœ… Messages ëª¨ë“ˆ (6-8ê°œ API)
2. âœ… Notifications ëª¨ë“ˆ (4-6ê°œ API)
3. âœ… Favorites ëª¨ë“ˆ (3-4ê°œ API)
4. âœ… ì´ë²¤íŠ¸ í†µí•© ì‹œìŠ¤í…œ
5. âœ… í†µí•© í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸
6. âœ… ë¦¬íŒ©í† ë§ëœ ì½”ë“œë² ì´ìŠ¤
7. âœ… ìµœì‹  API ë¬¸ì„œ
8. âœ… ê°œë°œ ê°€ì´ë“œ ë¬¸ì„œ

---

## ğŸ“… ìƒì„¸ ê°œë°œ ì¼ì •

### Week 11: Messages ëª¨ë“ˆ êµ¬í˜„ (5ì¼)

#### ğŸ“Œ Day 1: Repository ë° Service êµ¬í˜„

**ì˜¤ì „: Repository êµ¬í˜„**

```typescript
// src/modules/messages/repositories/messages.repository.ts

@Injectable()
export class MessagesRepository {
  constructor(private readonly prisma: PrismaService) {}

  /**
   * ì±„íŒ…ë°© ìƒì„± ë˜ëŠ” ì¡°íšŒ
   * - ê°™ì€ ìƒí’ˆì— ëŒ€í•œ ì±„íŒ…ë°©ì´ ì´ë¯¸ ìˆìœ¼ë©´ ê¸°ì¡´ ì±„íŒ…ë°© ë°˜í™˜
   */
  async findOrCreateChatRoom(userId: string, productId: string) {
    // ê¸°ì¡´ ì±„íŒ…ë°© ì¡°íšŒ
    const existingRoom = await this.prisma.chatRoom.findFirst({
      where: {
        productId,
        members: {
          some: { userId },
        },
      },
      include: {
        members: {
          include: {
            user: {
              select: {
                id: true,
                nickname: true,
                profileImage: true,
              },
            },
          },
        },
      },
    });

    if (existingRoom) {
      return existingRoom;
    }

    // ìƒí’ˆ ì •ë³´ ì¡°íšŒ (íŒë§¤ì í™•ì¸)
    const product = await this.prisma.product.findUnique({
      where: { id: productId },
      select: { sellerId: true },
    });

    if (!product) {
      throw new NotFoundException('ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    // ìƒˆ ì±„íŒ…ë°© ìƒì„± (êµ¬ë§¤ì + íŒë§¤ì)
    return this.prisma.chatRoom.create({
      data: {
        productId,
        members: {
          create: [
            { userId }, // ìš”ì²­ì (êµ¬ë§¤ì)
            { userId: product.sellerId }, // íŒë§¤ì
          ],
        },
      },
      include: {
        members: {
          include: {
            user: {
              select: {
                id: true,
                nickname: true,
                profileImage: true,
              },
            },
          },
        },
      },
    });
  }

  /**
   * ë©”ì‹œì§€ ì „ì†¡
   */
  async createMessage(
    senderId: string,
    chatRoomId: string,
    content: string,
    messageType: MessageType = MessageType.TEXT,
    fileUrl?: string,
    fileName?: string,
  ) {
    return this.prisma.chatMessage.create({
      data: {
        chatRoomId,
        senderId,
        content,
        messageType,
        fileUrl,
        fileName,
      },
      include: {
        sender: {
          select: {
            id: true,
            nickname: true,
            profileImage: true,
          },
        },
      },
    });
  }

  /**
   * ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ (ì‚¬ìš©ìë³„)
   */
  async findChatRoomsByUserId(userId: string) {
    return this.prisma.chatRoom.findMany({
      where: {
        members: {
          some: { userId },
        },
      },
      include: {
        members: {
          include: {
            user: {
              select: {
                id: true,
                nickname: true,
                profileImage: true,
              },
            },
          },
        },
        messages: {
          orderBy: { createdAt: 'desc' },
          take: 1, // ë§ˆì§€ë§‰ ë©”ì‹œì§€ 1ê°œë§Œ
          include: {
            sender: {
              select: {
                id: true,
                nickname: true,
              },
            },
          },
        },
      },
      orderBy: { updatedAt: 'desc' },
    });
  }

  /**
   * ì±„íŒ…ë°© ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ì¡°íšŒ (í˜ì´ì§€ë„¤ì´ì…˜)
   */
  async findMessagesByRoomId(
    chatRoomId: string,
    page: number = 1,
    limit: number = 50,
  ) {
    const skip = (page - 1) * limit;

    const [messages, total] = await Promise.all([
      this.prisma.chatMessage.findMany({
        where: { chatRoomId },
        skip,
        take: limit,
        orderBy: { createdAt: 'desc' }, // ìµœì‹  ë©”ì‹œì§€ë¶€í„°
        include: {
          sender: {
            select: {
              id: true,
              nickname: true,
              profileImage: true,
            },
          },
        },
      }),
      this.prisma.chatMessage.count({ where: { chatRoomId } }),
    ]);

    return {
      messages: messages.reverse(), // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    };
  }

  /**
   * ì½ìŒ ì²˜ë¦¬
   */
  async markMessagesAsRead(chatRoomId: string, userId: string) {
    // ìƒëŒ€ë°©ì´ ë³´ë‚¸ ë©”ì‹œì§€ë§Œ ì½ìŒ ì²˜ë¦¬
    await this.prisma.chatMessage.updateMany({
      where: {
        chatRoomId,
        senderId: { not: userId },
        isRead: false,
      },
      data: {
        isRead: true,
        readAt: new Date(),
      },
    });

    // ë©¤ë²„ì˜ lastReadAt ì—…ë°ì´íŠ¸
    await this.prisma.chatRoomMember.updateMany({
      where: {
        chatRoomId,
        userId,
      },
      data: {
        lastReadAt: new Date(),
      },
    });
  }

  /**
   * ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ì¡°íšŒ
   */
  async getUnreadCount(chatRoomId: string, userId: string) {
    return this.prisma.chatMessage.count({
      where: {
        chatRoomId,
        senderId: { not: userId },
        isRead: false,
      },
    });
  }

  /**
   * ì±„íŒ…ë°© ìƒì„¸ ì¡°íšŒ
   */
  async findChatRoomById(chatRoomId: string) {
    return this.prisma.chatRoom.findUnique({
      where: { id: chatRoomId },
      include: {
        members: {
          include: {
            user: {
              select: {
                id: true,
                nickname: true,
                profileImage: true,
              },
            },
          },
        },
      },
    });
  }

  /**
   * ì±„íŒ…ë°© ë‚˜ê°€ê¸°
   */
  async leaveChatRoom(chatRoomId: string, userId: string) {
    await this.prisma.chatRoomMember.deleteMany({
      where: {
        chatRoomId,
        userId,
      },
    });

    // ë©¤ë²„ê°€ ì—†ìœ¼ë©´ ì±„íŒ…ë°© ì‚­ì œ
    const remainingMembers = await this.prisma.chatRoomMember.count({
      where: { chatRoomId },
    });

    if (remainingMembers === 0) {
      await this.prisma.chatRoom.delete({
        where: { id: chatRoomId },
      });
    }
  }
}
```

**ì‘ì—… í•­ëª©**:
- [ ] MessagesRepository í´ë˜ìŠ¤ ìƒì„±
- [ ] ì±„íŒ…ë°© ìƒì„±/ì¡°íšŒ ë¡œì§ êµ¬í˜„
- [ ] ë©”ì‹œì§€ CRUD ë©”ì„œë“œ êµ¬í˜„
- [ ] ì½ìŒ ì²˜ë¦¬ ë° ì•ˆì½ì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸
- [ ] í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§ êµ¬í˜„

**ì˜¤í›„: Service êµ¬í˜„**

```typescript
// src/modules/messages/messages.service.ts

@Injectable()
export class MessagesService {
  constructor(
    private readonly repository: MessagesRepository,
    private readonly productsService: ProductsService,
    private readonly eventEmitter: EventEmitter2,
  ) {}

  /**
   * ì±„íŒ…ë°© ìƒì„± ë˜ëŠ” ì¡°íšŒ
   *
   * ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™:
   * 1. ìƒí’ˆì´ ì¡´ì¬í•´ì•¼ í•¨
   * 2. ìƒí’ˆì´ íŒë§¤ ê°€ëŠ¥ ìƒíƒœì—¬ì•¼ í•¨
   * 3. ë³¸ì¸ ìƒí’ˆì—ëŠ” ì±„íŒ… ë¶ˆê°€
   */
  async findOrCreateChatRoom(userId: string, productId: string) {
    // ìƒí’ˆ ì¡´ì¬ í™•ì¸
    const product = await this.productsService.findById(productId);

    // ë³¸ì¸ ìƒí’ˆ í™•ì¸
    if (product.sellerId === userId) {
      throw new BadRequestException('ë³¸ì¸ ìƒí’ˆì—ëŠ” ì±„íŒ…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    // ìƒí’ˆ ìƒíƒœ í™•ì¸
    if (product.status === ProductStatus.DELETED) {
      throw new BadRequestException('ì‚­ì œëœ ìƒí’ˆì…ë‹ˆë‹¤');
    }

    const chatRoom = await this.repository.findOrCreateChatRoom(
      userId,
      productId,
    );

    // ìƒˆ ì±„íŒ…ë°© ìƒì„± ì‹œ ì•Œë¦¼
    if (chatRoom.isNew) {
      this.eventEmitter.emit('chatroom.created', {
        chatRoomId: chatRoom.room.id,
        productId,
        buyerId: userId,
        sellerId: product.sellerId,
      });
    }

    return chatRoom.room;
  }

  /**
   * ë©”ì‹œì§€ ì „ì†¡
   *
   * ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™:
   * 1. ì±„íŒ…ë°© ë©¤ë²„ë§Œ ì „ì†¡ ê°€ëŠ¥
   * 2. ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ê²€ì¦ (íŒŒì¼, ì´ë¯¸ì§€)
   */
  async sendMessage(
    userId: string,
    chatRoomId: string,
    content: string,
    messageType: MessageType = MessageType.TEXT,
    fileUrl?: string,
    fileName?: string,
  ) {
    // ì±„íŒ…ë°© ë©¤ë²„ í™•ì¸
    const chatRoom = await this.repository.findChatRoomById(chatRoomId);
    if (!chatRoom) {
      throw new NotFoundException('ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    const isMember = chatRoom.members.some(
      (member) => member.userId === userId,
    );
    if (!isMember) {
      throw new ForbiddenException('ì±„íŒ…ë°© ë©¤ë²„ë§Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
    }

    // ë©”ì‹œì§€ ìƒì„±
    const message = await this.repository.createMessage(
      userId,
      chatRoomId,
      content,
      messageType,
      fileUrl,
      fileName,
    );

    // ì±„íŒ…ë°© updatedAt ê°±ì‹ 
    await this.prisma.chatRoom.update({
      where: { id: chatRoomId },
      data: { updatedAt: new Date() },
    });

    // ìƒëŒ€ë°©ì—ê²Œ ì•Œë¦¼ ì „ì†¡
    this.eventEmitter.emit('message.sent', {
      messageId: message.id,
      chatRoomId,
      senderId: userId,
      receiverId,
      content,
    });

    return message;
  }

  /**
   * ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ
   */
  async findMyChatRooms(userId: string) {
    const chatRooms = await this.repository.findChatRoomsByUserId(userId);

    // ê° ì±„íŒ…ë°©ì˜ ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ê³„ì‚°
    const chatRoomsWithUnread = await Promise.all(
      chatRooms.map(async (room) => {
        const unreadCount = await this.repository.getUnreadCount(
          room.id,
          userId,
        );

        return {
          ...room,
          unreadCount,
        };
      }),
    );
    return chatRoomsWithUnread;
  }

  /**
   * ì±„íŒ…ë°© ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ì¡°íšŒ
   */
  async findMessages(userId: string, chatRoomId: string, page: number = 1) {
    // ì±„íŒ…ë°© ë©¤ë²„ í™•ì¸
    const chatRoom = await this.repository.findChatRoomById(chatRoomId);
    if (!chatRoom) {
      throw new NotFoundException('ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    const isMember = chatRoom.members.some(
      (member) => member.userId === userId,
    );
    if (!isMember) {
      throw new ForbiddenException('ì±„íŒ…ë°© ë©¤ë²„ë§Œ ë©”ì‹œì§€ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
    }

    // ë©”ì‹œì§€ ì¡°íšŒ
    return this.repository.findMessagesByRoomId(chatRoomId, page);
  }

  /**
   * ì½ìŒ ì²˜ë¦¬
   */
  async markAsRead(userId: string, chatRoomId: string) {
    // ì±„íŒ…ë°© ë©¤ë²„ í™•ì¸
    const chatRoom = await this.repository.findChatRoomById(chatRoomId);
    if (!chatRoom) {
      throw new NotFoundException('ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    const isMember = chatRoom.members.some(
      (member) => member.userId === userId,
    );
    if (!isMember) {
      throw new ForbiddenException('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
    }

    await this.repository.markMessagesAsRead(chatRoomId, userId);
  }

  /**
   * ì±„íŒ…ë°© ë‚˜ê°€ê¸°
   */
  async leaveChatRoom(userId: string, chatRoomId: string) {
    // ì±„íŒ…ë°© ë©¤ë²„ í™•ì¸
    const chatRoom = await this.repository.findChatRoomById(chatRoomId);
    if (!chatRoom) {
      throw new NotFoundException('ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    const isMember = chatRoom.members.some(
      (member) => member.userId === userId,
    );
    if (!isMember) {
      throw new ForbiddenException('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
    }

    await this.repository.leaveChatRoom(chatRoomId, userId);
  }
}
```

**ì‘ì—… í•­ëª©**:
- [ ] MessagesService í´ë˜ìŠ¤ ìƒì„±
- [ ] ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„ (ê¶Œí•œ ê²€ì¦)
- [ ] ì´ë²¤íŠ¸ ë°œí–‰ (message.sent, chatroom.created)
- [ ] ì˜ˆì™¸ ì²˜ë¦¬ ì¶”ê°€

---

#### ğŸ“Œ Day 2: Controller ë° DTO êµ¬í˜„

**ì˜¤ì „: DTO ì‘ì„±**

```typescript
// src/modules/messages/dto/create-chatroom.dto.ts
export class CreateChatRoomDto {
  @ApiProperty({ description: 'ìƒí’ˆ ID' })
  @IsString()
  productId: string;
}

// src/modules/messages/dto/send-message.dto.ts
export class SendMessageDto {
  @ApiProperty({ description: 'ì±„íŒ…ë°© ID' })
  @IsString()
  chatRoomId: string;

  @ApiProperty({ description: 'ë©”ì‹œì§€ ë‚´ìš©' })
  @IsString()
  @IsNotEmpty()
  content: string;

  @ApiPropertyOptional({ description: 'ë©”ì‹œì§€ íƒ€ì…', enum: MessageType })
  @IsOptional()
  @IsEnum(MessageType)
  messageType?: MessageType;

  @ApiPropertyOptional({ description: 'íŒŒì¼ URL' })
  @IsOptional()
  @IsString()
  fileUrl?: string;

  @ApiPropertyOptional({ description: 'íŒŒì¼ëª…' })
  @IsOptional()
  @IsString()
  fileName?: string;
}

// src/modules/messages/dto/query-messages.dto.ts
export class QueryMessagesDto {
  @ApiPropertyOptional({ description: 'í˜ì´ì§€ ë²ˆí˜¸', default: 1 })
  @IsOptional()
  @Type(() => Number)
  @IsInt()
  @Min(1)
  page?: number = 1;

  @ApiPropertyOptional({ description: 'í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜', default: 50 })
  @IsOptional()
  @Type(() => Number)
  @IsInt()
  @Min(1)
  @Max(100)
  limit?: number = 50;
}
```

**ì˜¤í›„: Controller êµ¬í˜„**

```typescript
// src/modules/messages/messages.controller.ts

@ApiTags('messages')
@Controller('messages')
@UseGuards(JwtAuthGuard)
export class MessagesController {
  constructor(private readonly messagesService: MessagesService) {}

  /**
   * ì±„íŒ…ë°© ìƒì„± ë˜ëŠ” ì¡°íšŒ
   */
  @Post('chatrooms')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì±„íŒ…ë°© ìƒì„± ë˜ëŠ” ì¡°íšŒ' })
  @ApiResponse({ status: 201, description: 'ì±„íŒ…ë°© ìƒì„±/ì¡°íšŒ ì„±ê³µ' })
  async createOrFindChatRoom(
    @CurrentUser('userId') userId: string,
    @Body() dto: CreateChatRoomDto,
  ) {
    return this.messagesService.findOrCreateChatRoom(userId, dto.productId);
  }

  /**
   * ë‚´ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ
   */
  @Get('chatrooms')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ë‚´ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ' })
  @ApiResponse({ status: 200, description: 'ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì„±ê³µ' })
  async getMyChatRooms(@CurrentUser('userId') userId: string) {
    return this.messagesService.findMyChatRooms(userId);
  }

  /**
   * ì±„íŒ…ë°© ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ì¡°íšŒ
   */
  @Get('chatrooms/:chatRoomId/messages')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì±„íŒ…ë°© ë©”ì‹œì§€ ì¡°íšŒ' })
  @ApiResponse({ status: 200, description: 'ë©”ì‹œì§€ ì¡°íšŒ ì„±ê³µ' })
  async getMessages(
    @CurrentUser('userId') userId: string,
    @Param('chatRoomId') chatRoomId: string,
    @Query() query: QueryMessagesDto,
  ) {
    return this.messagesService.findMessages(
      userId,
      chatRoomId,
      query.page,
    );
  }

  /**
   * ë©”ì‹œì§€ ì „ì†¡
   */
  @Post()
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ë©”ì‹œì§€ ì „ì†¡' })
  @ApiResponse({ status: 201, description: 'ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ' })
  async sendMessage(
    @CurrentUser('userId') userId: string,
    @Body() dto: SendMessageDto,
  ) {
    return this.messagesService.sendMessage(
      userId,
      dto.chatRoomId,
      dto.content,
      dto.messageType,
      dto.fileUrl,
      dto.fileName,
    );
  }

  /**
   * ì½ìŒ ì²˜ë¦¬
   */
  @Patch('chatrooms/:chatRoomId/read')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬' })
  @ApiResponse({ status: 200, description: 'ì½ìŒ ì²˜ë¦¬ ì„±ê³µ' })
  @HttpCode(HttpStatus.OK)
  async markAsRead(
    @CurrentUser('userId') userId: string,
    @Param('chatRoomId') chatRoomId: string,
  ) {
    await this.messagesService.markAsRead(userId, chatRoomId);
    return { success: true };
  }

  /**
   * ì±„íŒ…ë°© ë‚˜ê°€ê¸°
   */
  @Delete('chatrooms/:chatRoomId')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì±„íŒ…ë°© ë‚˜ê°€ê¸°' })
  @ApiResponse({ status: 204, description: 'ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì„±ê³µ' })
  @HttpCode(HttpStatus.NO_CONTENT)
  async leaveChatRoom(
    @CurrentUser('userId') userId: string,
    @Param('chatRoomId') chatRoomId: string,
  ) {
    await this.messagesService.leaveChatRoom(userId, chatRoomId);
  }
}
```

**ì‘ì—… í•­ëª©**:
- [ ] 3ê°œ DTO ì‘ì„± (CreateChatRoom, SendMessage, QueryMessages)
- [ ] MessagesController êµ¬í˜„ (6ê°œ ì—”ë“œí¬ì¸íŠ¸)
- [ ] Swagger ë¬¸ì„œí™” ë°ì½”ë ˆì´í„° ì¶”ê°€
- [ ] MessagesModule êµ¬ì„±

---

#### ğŸ“Œ Day 3-4: E2E í…ŒìŠ¤íŠ¸ ì‘ì„±

**í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤**:
1. âœ… ì±„íŒ…ë°© ìƒì„± ì„±ê³µ
2. âœ… ë³¸ì¸ ìƒí’ˆì— ì±„íŒ… ì‹œë„ ì‹œ ì‹¤íŒ¨
3. âœ… ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ
4. âœ… ì±„íŒ…ë°© ë©¤ë²„ë§Œ ë©”ì‹œì§€ ì „ì†¡ ê°€ëŠ¥
5. âœ… ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ
6. âœ… ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ê³„ì‚°
7. âœ… ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ì¡°íšŒ
8. âœ… í˜ì´ì§€ë„¤ì´ì…˜ ë™ì‘ í™•ì¸
9. âœ… ì½ìŒ ì²˜ë¦¬ ì„±ê³µ
10. âœ… ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì„±ê³µ
11. âœ… ë©¤ë²„ê°€ ëª¨ë‘ ë‚˜ê°€ë©´ ì±„íŒ…ë°© ì‚­ì œ
12. âœ… ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì ì ‘ê·¼ ì°¨ë‹¨

**ì˜ˆìƒ E2E í…ŒìŠ¤íŠ¸**: 12-15ê°œ

---

#### ğŸ“Œ Day 5: ì´ë²¤íŠ¸ í†µí•© ë° ì•Œë¦¼ ì—°ë™

**ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„**:

```typescript
// src/modules/notifications/listeners/message.listener.ts

@Injectable()
export class MessageListener {
  constructor(private readonly notificationsService: NotificationsService) {}

  @OnEvent('message.sent')
  async handleMessageSent(payload: {
    messageId: string;
    chatRoomId: string;
    senderId: string;
    receiverId: string;
    content: string;
  }) {
    // ìˆ˜ì‹ ìì—ê²Œ ì•Œë¦¼ ìƒì„±
    await this.notificationsService.create({
      userId: payload.receiverId,
      type: NotificationType.NEW_MESSAGE,
      title: 'ìƒˆ ë©”ì‹œì§€',
      message: payload.content.substring(0, 50), // ë¯¸ë¦¬ë³´ê¸°
      relatedId: payload.chatRoomId,
      relatedType: 'chatroom',
    });
  }

  @OnEvent('chatroom.created')
  async handleChatRoomCreated(payload: {
    chatRoomId: string;
    productId: string;
    buyerId: string;
    sellerId: string;
  }) {
    // íŒë§¤ìì—ê²Œ ì•Œë¦¼ ìƒì„±
    await this.notificationsService.create({
      userId: payload.sellerId,
      type: NotificationType.NEW_MESSAGE,
      title: 'ìƒˆ ì±„íŒ… ìš”ì²­',
      message: 'ìƒí’ˆì— ëŒ€í•œ ì±„íŒ… ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤',
      relatedId: payload.chatRoomId,
      relatedType: 'chatroom',
    });
  }
}
```

**ì‘ì—… í•­ëª©**:
- [ ] ë©”ì‹œì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„
- [ ] ì•Œë¦¼ ìë™ ìƒì„± ë¡œì§
- [ ] RabbitMQ ë©”ì‹œì§€ í í†µí•© (ì„ íƒì )

---

### Week 12: Notifications ëª¨ë“ˆ êµ¬í˜„ (3ì¼)

#### ğŸ“Œ Day 1: Repository ë° Service êµ¬í˜„

**Repository êµ¬í˜„**:

```typescript
// src/modules/notifications/repositories/notifications.repository.ts

@Injectable()
export class NotificationsRepository {
  constructor(private readonly prisma: PrismaService) {}

  /**
   * ì•Œë¦¼ ìƒì„±
   */
  async create(data: {
    userId: string;
    type: NotificationType;
    title: string;
    message: string;
    relatedId?: string;
    relatedType?: string;
  }) {
    return this.prisma.notification.create({
      data,
    });
  }

  /**
   * ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ (í˜ì´ì§€ë„¤ì´ì…˜)
   */
  async findMany(userId: string, page: number = 1, limit: number = 20) {
    const skip = (page - 1) * limit;

    const [items, total, unreadCount] = await Promise.all([
      this.prisma.notification.findMany({
        where: { userId },
        skip,
        take: limit,
        orderBy: { createdAt: 'desc' },
      }),
      this.prisma.notification.count({ where: { userId } }),
      this.prisma.notification.count({
        where: { userId, isRead: false },
      }),
    ]);

    return {
      items,
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
      unreadCount,
    };
  }

  /**
   * ì½ìŒ ì²˜ë¦¬
   */
  async markAsRead(id: string, userId: string) {
    return this.prisma.notification.updateMany({
      where: { id, userId },
      data: {
        isRead: true,
        readAt: new Date(),
      },
    });
  }

  /**
   * ì „ì²´ ì½ìŒ ì²˜ë¦¬
   */
  async markAllAsRead(userId: string) {
    return this.prisma.notification.updateMany({
      where: { userId, isRead: false },
      data: {
        isRead: true,
        readAt: new Date(),
      },
    });
  }

  /**
   * ì•Œë¦¼ ì‚­ì œ
   */
  async delete(id: string, userId: string) {
    return this.prisma.notification.deleteMany({
      where: { id, userId },
    });
  }

  /**
   * ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ ì¡°íšŒ
   */
  async getUnreadCount(userId: string) {
    return this.prisma.notification.count({
      where: { userId, isRead: false },
    });
  }
}
```

**Service êµ¬í˜„**:

```typescript
// src/modules/notifications/notifications.service.ts

@Injectable()
export class NotificationsService {
  constructor(
    private readonly repository: NotificationsRepository,
  ) {}

  /**
   * ì•Œë¦¼ ìƒì„±
   */
  async create(data: {
    userId: string;
    type: NotificationType;
    title: string;
    message: string;
    relatedId?: string;
    relatedType?: string;
  }) {
    return this.repository.create(data);
  }

  /**
   * ë‚´ ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ
   */
  async findMyNotifications(userId: string, page: number = 1) {
    return this.repository.findMany(userId, page);
  }

  /**
   * ì½ìŒ ì²˜ë¦¬
   */
  async markAsRead(userId: string, id: string) {
    const result = await this.repository.markAsRead(id, userId);

    if (result.count === 0) {
      throw new NotFoundException('ì•Œë¦¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
  }

  /**
   * ì „ì²´ ì½ìŒ ì²˜ë¦¬
   */
  async markAllAsRead(userId: string) {
    await this.repository.markAllAsRead(userId);
  }

  /**
   * ì•Œë¦¼ ì‚­ì œ
   */
  async delete(userId: string, id: string) {
    const result = await this.repository.delete(id, userId);

    if (result.count === 0) {
      throw new NotFoundException('ì•Œë¦¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
  }

  /**
   * ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ ì¡°íšŒ
   */
  async getUnreadCount(userId: string) {
    return this.repository.getUnreadCount(userId);
  }
}
```

**ì‘ì—… í•­ëª©**:
- [ ] NotificationsRepository êµ¬í˜„
- [ ] NotificationsService êµ¬í˜„
- [ ] ì•Œë¦¼ ìƒì„± ë¡œì§
- [ ] ì½ìŒ ì²˜ë¦¬ ë¡œì§

---

#### ğŸ“Œ Day 2: Controller ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„

**Controller êµ¬í˜„**:

```typescript
// src/modules/notifications/notifications.controller.ts

@ApiTags('notifications')
@Controller('notifications')
@UseGuards(JwtAuthGuard)
export class NotificationsController {
  constructor(
    private readonly notificationsService: NotificationsService,
  ) {}

  /**
   * ë‚´ ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ
   */
  @Get()
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ë‚´ ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ' })
  async getMyNotifications(
    @CurrentUser('userId') userId: string,
    @Query('page') page: number = 1,
  ) {
    return this.notificationsService.findMyNotifications(userId, page);
  }

  /**
   * ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ ì¡°íšŒ
   */
  @Get('unread/count')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ ì¡°íšŒ' })
  async getUnreadCount(@CurrentUser('userId') userId: string) {
    const count = await this.notificationsService.getUnreadCount(userId);
    return { unreadCount: count };
  }

  /**
   * ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
   */
  @Patch(':id/read')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬' })
  @HttpCode(HttpStatus.OK)
  async markAsRead(
    @CurrentUser('userId') userId: string,
    @Param('id') id: string,
  ) {
    await this.notificationsService.markAsRead(userId, id);
    return { success: true };
  }

  /**
   * ì „ì²´ ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
   */
  @Patch('read-all')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì „ì²´ ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬' })
  @HttpCode(HttpStatus.OK)
  async markAllAsRead(@CurrentUser('userId') userId: string) {
    await this.notificationsService.markAllAsRead(userId);
    return { success: true };
  }

  /**
   * ì•Œë¦¼ ì‚­ì œ
   */
  @Delete(':id')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì•Œë¦¼ ì‚­ì œ' })
  @HttpCode(HttpStatus.NO_CONTENT)
  async delete(
    @CurrentUser('userId') userId: string,
    @Param('id') id: string,
  ) {
    await this.notificationsService.delete(userId, id);
  }
}
```

**ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í†µí•©**:

```typescript
// src/modules/notifications/listeners/order.listener.ts

@Injectable()
export class OrderListener {
  constructor(private readonly notificationsService: NotificationsService) {}

  @OnEvent('order.created')
  async handleOrderCreated(payload: {
    orderId: string;
    buyerId: string;
    sellerId: string;
  }) {
    // íŒë§¤ìì—ê²Œ ì•Œë¦¼
    await this.notificationsService.create({
      userId: payload.sellerId,
      type: NotificationType.ORDER_CREATED,
      title: 'ìƒˆ ì£¼ë¬¸',
      message: 'ìƒí’ˆì— ëŒ€í•œ ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤',
      relatedId: payload.orderId,
      relatedType: 'order',
    });
  }

  @OnEvent('order.confirmed')
  async handleOrderConfirmed(payload: {
    orderId: string;
    buyerId: string;
    sellerId: string;
  }) {
    // êµ¬ë§¤ìì—ê²Œ ì•Œë¦¼
    await this.notificationsService.create({
      userId: payload.buyerId,
      type: NotificationType.ORDER_CONFIRMED,
      title: 'ì£¼ë¬¸ í™•ì •',
      message: 'ì£¼ë¬¸ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤',
      relatedId: payload.orderId,
      relatedType: 'order',
    });
  }

  @OnEvent('order.cancelled')
  async handleOrderCancelled(payload: {
    orderId: string;
    buyerId: string;
    sellerId: string;
  }) {
    // íŒë§¤ìì—ê²Œ ì•Œë¦¼
    await this.notificationsService.create({
      userId: payload.sellerId,
      type: NotificationType.ORDER_CANCELLED,
      title: 'ì£¼ë¬¸ ì·¨ì†Œ',
      message: 'ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤',
      relatedId: payload.orderId,
      relatedType: 'order',
    });
  }

  @OnEvent('payment.completed')
  async handlePaymentCompleted(payload: {
    orderId: string;
    buyerId: string;
    sellerId: string;
  }) {
    // íŒë§¤ìì—ê²Œ ì•Œë¦¼
    await this.notificationsService.create({
      userId: payload.sellerId,
      type: NotificationType.PAYMENT_COMPLETED,
      title: 'ê²°ì œ ì™„ë£Œ',
      message: 'ì£¼ë¬¸ì— ëŒ€í•œ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
      relatedId: payload.orderId,
      relatedType: 'order',
    });
  }
}

// src/modules/notifications/listeners/review.listener.ts

@Injectable()
export class ReviewListener {
  constructor(private readonly notificationsService: NotificationsService) {}

  @OnEvent('review.created')
  async handleReviewCreated(payload: {
    reviewId: string;
    reviewerId: string;
    reviewedId: string;
  }) {
    // ë¦¬ë·° ëŒ€ìƒìì—ê²Œ ì•Œë¦¼
    await this.notificationsService.create({
      userId: payload.reviewedId,
      type: NotificationType.REVIEW_RECEIVED,
      title: 'ìƒˆ ë¦¬ë·°',
      message: 'ìƒˆë¡œìš´ ë¦¬ë·°ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
      relatedId: payload.reviewId,
      relatedType: 'review',
    });
  }
}
```

**ì‘ì—… í•­ëª©**:
- [ ] NotificationsController êµ¬í˜„ (5ê°œ ì—”ë“œí¬ì¸íŠ¸)
- [ ] ì£¼ë¬¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„
- [ ] ë¦¬ë·° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„
- [ ] NotificationsModule êµ¬ì„±

---

#### ğŸ“Œ Day 3: E2E í…ŒìŠ¤íŠ¸ ì‘ì„±

**í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤**:
1. âœ… ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ
2. âœ… ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ ì¡°íšŒ
3. âœ… ì½ìŒ ì²˜ë¦¬ ì„±ê³µ
4. âœ… ì „ì²´ ì½ìŒ ì²˜ë¦¬
5. âœ… ì•Œë¦¼ ì‚­ì œ
6. âœ… í˜ì´ì§€ë„¤ì´ì…˜ ë™ì‘
7. âœ… ì´ë²¤íŠ¸ ë°œí–‰ ì‹œ ìë™ ì•Œë¦¼ ìƒì„±
8. âœ… ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì•Œë¦¼ ì ‘ê·¼ ì°¨ë‹¨

**ì˜ˆìƒ E2E í…ŒìŠ¤íŠ¸**: 8-10ê°œ

---

### Week 13: Favorites ëª¨ë“ˆ ë° ì‹œìŠ¤í…œ í†µí•© (5ì¼)

#### ğŸ“Œ Day 1-2: Favorites ëª¨ë“ˆ êµ¬í˜„

**Repository ë° Service**:

```typescript
// src/modules/favorites/repositories/favorites.repository.ts

@Injectable()
export class FavoritesRepository {
  constructor(private readonly prisma: PrismaService) {}

  /**
   * ì°œí•˜ê¸° ì¶”ê°€
   */
  async create(userId: string, productId: string) {
    return this.prisma.favorite.create({
      data: { userId, productId },
      include: {
        product: {
          include: {
            category: true,
            seller: {
              select: {
                id: true,
                nickname: true,
                profileImage: true,
              },
            },
          },
        },
      },
    });
  }

  /**
   * ì°œí•˜ê¸° ëª©ë¡ ì¡°íšŒ (í˜ì´ì§€ë„¤ì´ì…˜)
   */
  async findMany(userId: string, page: number = 1, limit: number = 20) {
    const skip = (page - 1) * limit;

    const [items, total] = await Promise.all([
      this.prisma.favorite.findMany({
        where: { userId },
        skip,
        take: limit,
        orderBy: { createdAt: 'desc' },
        include: {
          product: {
            include: {
              category: true,
              seller: {
                select: {
                  id: true,
                  nickname: true,
                  profileImage: true,
                },
              },
            },
          },
        },
      }),
      this.prisma.favorite.count({ where: { userId } }),
    ]);

    return {
      items,
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    };
  }

  /**
   * ì°œí•˜ê¸° ì—¬ë¶€ í™•ì¸
   */
  async exists(userId: string, productId: string) {
    const favorite = await this.prisma.favorite.findUnique({
      where: {
        userId_productId: { userId, productId },
      },
    });

    return !!favorite;
  }

  /**
   * ì°œí•˜ê¸° ì‚­ì œ
   */
  async delete(userId: string, productId: string) {
    return this.prisma.favorite.deleteMany({
      where: { userId, productId },
    });
  }
}
```

**Service**:

```typescript
// src/modules/favorites/favorites.service.ts

@Injectable()
export class FavoritesService {
  constructor(
    private readonly repository: FavoritesRepository,
    private readonly productsService: ProductsService,
    private readonly eventEmitter: EventEmitter2,
  ) {}

  /**
   * ì°œí•˜ê¸° ì¶”ê°€
   */
  async addFavorite(userId: string, productId: string) {
    // ìƒí’ˆ ì¡´ì¬ í™•ì¸
    const product = await this.productsService.findById(productId);

    // ë³¸ì¸ ìƒí’ˆ í™•ì¸
    if (product.sellerId === userId) {
      throw new BadRequestException('ë³¸ì¸ ìƒí’ˆì€ ì°œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    // ì¤‘ë³µ í™•ì¸
    const exists = await this.repository.exists(userId, productId);
    if (exists) {
      throw new ConflictException('ì´ë¯¸ ì°œí•œ ìƒí’ˆì…ë‹ˆë‹¤');
    }

    const favorite = await this.repository.create(userId, productId);

    // íŒë§¤ìì—ê²Œ ì•Œë¦¼ ì´ë²¤íŠ¸ ë°œí–‰
    this.eventEmitter.emit('product.liked', {
      favoriteId: favorite.id,
      userId,
      productId,
      sellerId: product.sellerId,
    });

    return favorite;
  }

  /**
   * ì°œ ëª©ë¡ ì¡°íšŒ
   */
  async findMyFavorites(userId: string, page: number = 1) {
    return this.repository.findMany(userId, page);
  }

  /**
   * ì°œí•˜ê¸° ì—¬ë¶€ í™•ì¸
   */
  async checkFavorite(userId: string, productId: string) {
    const isFavorite = await this.repository.exists(userId, productId);
    return { isFavorite };
  }

  /**
   * ì°œí•˜ê¸° ì‚­ì œ
   */
  async removeFavorite(userId: string, productId: string) {
    const result = await this.repository.delete(userId, productId);

    if (result.count === 0) {
      throw new NotFoundException('ì°œí•œ ìƒí’ˆì´ ì•„ë‹™ë‹ˆë‹¤');
    }
  }
}
```

**Controller**:

```typescript
// src/modules/favorites/favorites.controller.ts

@ApiTags('favorites')
@Controller('favorites')
@UseGuards(JwtAuthGuard)
export class FavoritesController {
  constructor(private readonly favoritesService: FavoritesService) {}

  /**
   * ì°œí•˜ê¸° ì¶”ê°€
   */
  @Post()
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì°œí•˜ê¸° ì¶”ê°€' })
  async addFavorite(
    @CurrentUser('userId') userId: string,
    @Body('productId') productId: string,
  ) {
    return this.favoritesService.addFavorite(userId, productId);
  }

  /**
   * ì°œ ëª©ë¡ ì¡°íšŒ
   */
  @Get()
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì°œ ëª©ë¡ ì¡°íšŒ' })
  async getMyFavorites(
    @CurrentUser('userId') userId: string,
    @Query('page') page: number = 1,
  ) {
    return this.favoritesService.findMyFavorites(userId, page);
  }

  /**
   * ì°œí•˜ê¸° ì—¬ë¶€ í™•ì¸
   */
  @Get(':productId/check')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì°œí•˜ê¸° ì—¬ë¶€ í™•ì¸' })
  async checkFavorite(
    @CurrentUser('userId') userId: string,
    @Param('productId') productId: string,
  ) {
    return this.favoritesService.checkFavorite(userId, productId);
  }

  /**
   * ì°œí•˜ê¸° ì‚­ì œ
   */
  @Delete(':productId')
  @ApiBearerAuth('access-token')
  @ApiOperation({ summary: 'ì°œí•˜ê¸° ì‚­ì œ' })
  @HttpCode(HttpStatus.NO_CONTENT)
  async removeFavorite(
    @CurrentUser('userId') userId: string,
    @Param('productId') productId: string,
  ) {
    await this.favoritesService.removeFavorite(userId, productId);
  }
}
```

**E2E í…ŒìŠ¤íŠ¸**: 5-8ê°œ

**ì‘ì—… í•­ëª©**:
- [ ] FavoritesRepository êµ¬í˜„
- [ ] FavoritesService êµ¬í˜„
- [ ] FavoritesController êµ¬í˜„ (4ê°œ ì—”ë“œí¬ì¸íŠ¸)
- [ ] E2E í…ŒìŠ¤íŠ¸ ì‘ì„±
- [ ] ì•Œë¦¼ ì´ë²¤íŠ¸ í†µí•©

---

#### ğŸ“Œ Day 3: ì „ì—­ ì—ëŸ¬ ì²˜ë¦¬ ë° ì‘ë‹µ ë³€í™˜

**ì „ì—­ ì˜ˆì™¸ í•„í„°**:

```typescript
// src/common/filters/http-exception.filter.ts

@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  constructor(private readonly logger: Logger) {}

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    let status = HttpStatus.INTERNAL_SERVER_ERROR;
    let message = 'Internal server error';
    let error = 'Internal Server Error';

    if (exception instanceof HttpException) {
      status = exception.getStatus();
      const errorResponse = exception.getResponse();

      if (typeof errorResponse === 'string') {
        message = errorResponse;
      } else if (typeof errorResponse === 'object') {
        message = (errorResponse as any).message || message;
        error = (errorResponse as any).error || error;
      }
    } else if (exception instanceof Error) {
      message = exception.message;
    }

    // ë¡œê¹…
    this.logger.error({
      timestamp: new Date().toISOString(),
      path: request.url,
      method: request.method,
      statusCode: status,
      message,
      error,
      stack: exception instanceof Error ? exception.stack : undefined,
    });

    // í‘œì¤€ ì—ëŸ¬ ì‘ë‹µ í˜•ì‹
    response.status(status).json({
      success: false,
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      error,
      message,
    });
  }
}
```

**ì‘ë‹µ ë³€í™˜ ì¸í„°ì…‰í„°**:

```typescript
// src/common/interceptors/transform.interceptor.ts

export interface Response<T> {
  success: boolean;
  statusCode: number;
  timestamp: string;
  data: T;
  message?: string;
}

@Injectable()
export class TransformInterceptor<T>
  implements NestInterceptor<T, Response<T>>
{
  intercept(
    context: ExecutionContext,
    next: CallHandler,
  ): Observable<Response<T>> {
    return next.handle().pipe(
      map((data) => ({
        success: true,
        statusCode: context.switchToHttp().getResponse().statusCode,
        timestamp: new Date().toISOString(),
        data,
      })),
    );
  }
}
```

**ì‘ì—… í•­ëª©**:
- [ ] AllExceptionsFilter êµ¬í˜„
- [ ] TransformInterceptor êµ¬í˜„
- [ ] main.tsì— ì „ì—­ ë“±ë¡
- [ ] í…ŒìŠ¤íŠ¸ ê²€ì¦

---

#### ğŸ“Œ Day 4-5: í†µí•© í…ŒìŠ¤íŠ¸ ë° ë¦¬íŒ©í† ë§

**í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤**:

1. **ì „ì²´ ê±°ë˜ í”Œë¡œìš°**:
   - íšŒì›ê°€ì… â†’ ìƒí’ˆ ë“±ë¡ â†’ ì°œí•˜ê¸° â†’ ì±„íŒ… â†’ ì£¼ë¬¸ â†’ ê²°ì œ â†’ ë°°ì†¡ â†’ ë¦¬ë·°

2. **ì´ë²¤íŠ¸ ì—°ë™**:
   - ì£¼ë¬¸ ìƒì„± â†’ ì•Œë¦¼ ìë™ ìƒì„±
   - ë©”ì‹œì§€ ì „ì†¡ â†’ ì•Œë¦¼ ìë™ ìƒì„±
   - ë¦¬ë·° ì‘ì„± â†’ ì‹ ë¢°ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸

3. **ê¶Œí•œ ê²€ì¦**:
   - ì—­í• ë³„ ì ‘ê·¼ ì œì–´
   - ë³¸ì¸ ë°ì´í„°ë§Œ ìˆ˜ì • ê°€ëŠ¥

**ë¦¬íŒ©í† ë§ ëª©ë¡**:

```typescript
// ê³µí†µ DTO ì¶”ì¶œ
// src/common/dto/pagination.dto.ts
export class PaginationDto {
  @ApiPropertyOptional({ default: 1 })
  @Type(() => Number)
  @IsInt()
  @Min(1)
  page?: number = 1;

  @ApiPropertyOptional({ default: 20 })
  @Type(() => Number)
  @IsInt()
  @Min(1)
  @Max(100)
  limit?: number = 20;
}

// ê³µí†µ ì‘ë‹µ DTO
// src/common/dto/paginated-response.dto.ts
export class PaginatedResponseDto<T> {
  items: T[];
  total: number;
  page: number;
  limit: number;
  totalPages: number;

  constructor(partial: Partial<PaginatedResponseDto<T>>) {
    Object.assign(this, partial);
  }
}
```

**ì‘ì—… í•­ëª©**:
- [ ] ì „ì²´ ê±°ë˜ í”Œë¡œìš° E2E í…ŒìŠ¤íŠ¸
- [ ] ì´ë²¤íŠ¸ ì—°ë™ í…ŒìŠ¤íŠ¸
- [ ] ê³µí†µ DTO ì¶”ì¶œ
- [ ] ì½”ë“œ ì¤‘ë³µ ì œê±°
- [ ] íƒ€ì… ì •ì˜ ìµœì í™”

---

### Week 14: ë¬¸ì„œí™” ë° ìµœì¢… ê²€ì¦ (5ì¼)

#### ğŸ“Œ Day 1-2: API ë¬¸ì„œ ìµœì‹ í™”

**Swagger ë¬¸ì„œ ê°œì„ **:

```typescript
// src/main.tsì— Swagger ì„¤ì • ê°•í™”

const config = new DocumentBuilder()
  .setTitle('ì¤‘ê³ ê±°ë˜ í”Œë«í¼ API')
  .setDescription('ì¤‘ê³ ê±°ë˜ í”Œë«í¼ ë°±ì—”ë“œ API ë¬¸ì„œ')
  .setVersion('1.0')
  .addBearerAuth(
    {
      type: 'http',
      scheme: 'bearer',
      bearerFormat: 'JWT',
      description: 'Access Token',
    },
    'access-token',
  )
  .addTag('users', 'ì‚¬ìš©ì ê´€ë¦¬')
  .addTag('products', 'ìƒí’ˆ ê´€ë¦¬')
  .addTag('categories', 'ì¹´í…Œê³ ë¦¬ ê´€ë¦¬')
  .addTag('orders', 'ì£¼ë¬¸ ê´€ë¦¬')
  .addTag('reviews', 'ë¦¬ë·° ê´€ë¦¬')
  .addTag('messages', 'ë©”ì‹œì§€/ì±„íŒ…')
  .addTag('notifications', 'ì•Œë¦¼')
  .addTag('favorites', 'ì°œí•˜ê¸°')
  .build();

const document = SwaggerModule.createDocument(app, config);
SwaggerModule.setup('api/docs', app, document, {
  swaggerOptions: {
    persistAuthorization: true,
    tagsSorter: 'alpha',
    operationsSorter: 'alpha',
  },
});
```

**ì‘ì—… í•­ëª©**:
- [ ] ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ Swagger ë¬¸ì„œí™”
- [ ] ì˜ˆì‹œ ìš”ì²­/ì‘ë‹µ ì¶”ê°€
- [ ] ì—ëŸ¬ ì‘ë‹µ ë¬¸ì„œí™”

---

#### ğŸ“Œ Day 3: README ë° ê°œë°œ ê°€ì´ë“œ

**README.md êµ¬ì¡°**:

```markdown
# ì¤‘ê³ ê±°ë˜ í”Œë«í¼ ë°±ì—”ë“œ API

## í”„ë¡œì íŠ¸ ê°œìš”
- ê¸°ìˆ  ìŠ¤íƒ
- ì£¼ìš” ê¸°ëŠ¥
- ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

## ì‹œì‘í•˜ê¸°
- ì‚¬ì „ ìš”êµ¬ì‚¬í•­
- ì„¤ì¹˜ ë°©ë²•
- í™˜ê²½ ì„¤ì •
- ì‹¤í–‰ ë°©ë²•

## API ë¬¸ì„œ
- Swagger UI ë§í¬
- ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸ ì„¤ëª…

## ê°œë°œ ê°€ì´ë“œ
- í”„ë¡œì íŠ¸ êµ¬ì¡°
- ê°œë°œ íŒ¨í„´
- ì½”ë”© ì»¨ë²¤ì…˜
- í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ë°°í¬
- Docker ë¹Œë“œ
- í™˜ê²½ë³„ ì„¤ì •
- CI/CD

## ë¼ì´ì„ ìŠ¤
```

**ì‘ì—… í•­ëª©**:
- [ ] README.md ì‘ì„±
- [ ] API ì‚¬ìš© ê°€ì´ë“œ
- [ ] ê°œë°œ í™˜ê²½ ì„¤ì • ê°€ì´ë“œ
- [ ] ë°°í¬ ê°€ì´ë“œ

---

#### ğŸ“Œ Day 4-5: ìµœì¢… ê²€ì¦ ë° ë¦´ë¦¬ì¦ˆ ì¤€ë¹„

**ì²´í¬ë¦¬ìŠ¤íŠ¸**:

1. âœ… ëª¨ë“  E2E í…ŒìŠ¤íŠ¸ í†µê³¼ (ëª©í‘œ: 97-112ê°œ)
2. âœ… ë¹Œë“œ ì„±ê³µ (TypeScript strict ëª¨ë“œ)
3. âœ… ESLint 0 ì—ëŸ¬
4. âœ… Prettier í¬ë§·íŒ… ì¼ê´€ì„±
5. âœ… API ë¬¸ì„œ ì™„ì„±
6. âœ… README ì‘ì„±
7. âœ… í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
8. âœ… Docker ë¹Œë“œ ì„±ê³µ
9. âœ… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (API ì‘ë‹µ ì‹œê°„ <200ms)
10. âœ… ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

**ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì‘ì„±**:

```markdown
# Release Notes - Phase 4

## ë²„ì „: v1.0.0
## ë¦´ë¦¬ì¦ˆ ë‚ ì§œ: 2025-XX-XX

### ìƒˆë¡œìš´ ê¸°ëŠ¥
- Messages ëª¨ë“ˆ: ì‹¤ì‹œê°„ 1:1 ì±„íŒ… ì‹œìŠ¤í…œ
- Notifications ëª¨ë“ˆ: í†µí•© ì•Œë¦¼ ì‹œìŠ¤í…œ
- Favorites ëª¨ë“ˆ: ìƒí’ˆ ì°œí•˜ê¸° ê¸°ëŠ¥
- ì „ì—­ ì—ëŸ¬ ì²˜ë¦¬ ë° ì‘ë‹µ ë³€í™˜
- ì´ë²¤íŠ¸ ê¸°ë°˜ ë„ë©”ì¸ ê°„ ì—°ë™

### API ì—”ë“œí¬ì¸íŠ¸
- Messages: 6ê°œ API
- Notifications: 5ê°œ API
- Favorites: 4ê°œ API

### í…ŒìŠ¤íŠ¸
- E2E í…ŒìŠ¤íŠ¸: 97-112ê°œ (100% í†µê³¼)
- í†µí•© í…ŒìŠ¤íŠ¸: ì „ì²´ ê±°ë˜ í”Œë¡œìš°

### ê¸°ìˆ  ìŠ¤íƒ
- NestJS 11.x
- TypeScript 5.7.3
- Prisma ORM 6.2.0
- PostgreSQL
- Redis
- RabbitMQ

### ê°œì„ ì‚¬í•­
- ê³µí†µ DTO ì¶”ì¶œ ë° ì¬ì‚¬ìš©
- ì½”ë“œ ë¦¬íŒ©í† ë§ ë° ìµœì í™”
- API ë¬¸ì„œ ìë™í™”
- ì „ì—­ ì—ëŸ¬ ì²˜ë¦¬ í‘œì¤€í™”
```

---

## ğŸ“Š Phase 4 ìµœì¢… ì‚°ì¶œë¬¼

### ëª¨ë“ˆë³„ ì™„ì„±ë„

| ëª¨ë“ˆ | API | E2E í…ŒìŠ¤íŠ¸ | ìƒíƒœ |
|------|-----|-----------|------|
| Users | 6 | 13 | âœ… |
| Products | 8 | 21 | âœ… |
| Categories | 5 | 11 | âœ… |
| Orders | 8 | 17 | âœ… |
| Reviews | 7 | 10-15 | âœ… |
| **Messages** | 6 | 12-15 | ğŸ“ Week 11 |
| **Notifications** | 5 | 8-10 | ğŸ“ Week 12 |
| **Favorites** | 4 | 5-8 | ğŸ“ Week 13 |

**ì´ê³„**: 8ê°œ ëª¨ë“ˆ, 49ê°œ API, 97-110ê°œ E2E í…ŒìŠ¤íŠ¸

### ê¸°ìˆ  ì§€í‘œ

**ì½”ë“œ í’ˆì§ˆ**:
- âœ… TypeScript Strict Mode
- âœ… ESLint 0 ì—ëŸ¬
- âœ… Prettier ì¼ê´€ëœ í¬ë§·íŒ…
- âœ… 100% ë¹Œë“œ ì„±ê³µë¥ 

**í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**:
- âœ… E2E í…ŒìŠ¤íŠ¸: 100% í†µê³¼
- âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: 100% í†µê³¼
- âœ… í†µí•© í…ŒìŠ¤íŠ¸: ì „ì²´ í”Œë¡œìš°

**ì„±ëŠ¥ ëª©í‘œ**:
- âœ… API ì‘ë‹µ ì‹œê°„: <200ms
- âœ… ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬: <100ms
- âœ… ë™ì‹œ ì‚¬ìš©ì: 1,000ëª…
- âœ… ê°€ìš©ì„±: 99.9%

---

## ğŸ”‘ í•µì‹¬ ì„±ê³µ ìš”ì¸

### 1. ì™„ì„±ëœ ì¸í”„ë¼
- NestJS ëª¨ë“ˆí™” ì•„í‚¤í…ì²˜
- Prisma ORM íƒ€ì… ì•ˆì „ì„±
- JWT + RBAC ë³´ì•ˆ
- RabbitMQ ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ
- Winston ë¡œê¹…
- Docker í™˜ê²½

### 2. ê²€ì¦ëœ ê°œë°œ íŒ¨í„´
- Repository íŒ¨í„´
- Service íŒ¨í„´
- Controller íŒ¨í„´
- ìƒíƒœ ë¨¸ì‹  íŒ¨í„´
- ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜

### 3. ì²´ê³„ì ì¸ í…ŒìŠ¤íŠ¸
- E2E í…ŒìŠ¤íŠ¸ 100% ì»¤ë²„ë¦¬ì§€
- í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
- ê¶Œí•œ ê²€ì¦ í…ŒìŠ¤íŠ¸
- ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸

### 4. ëª…í™•í•œ ë¬¸ì„œí™”
- Swagger API ìë™ ë¬¸ì„œ
- README ë° ê°œë°œ ê°€ì´ë“œ
- ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸
- ì½”ë“œ ì£¼ì„

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„ (Phase 5 ì˜ˆìƒ)

### Week 15-16: ê²°ì œ ë° ê³ ê¸‰ ê¸°ëŠ¥ (ì„ íƒì )

1. **Payments ëª¨ë“ˆ**:
   - í† ìŠ¤í˜ì´ë¨¼ì¸  ì—°ë™
   - ê²°ì œ ìƒíƒœ ê´€ë¦¬
   - í™˜ë¶ˆ ì²˜ë¦¬

2. **ì„±ëŠ¥ ìµœì í™”**:
   - Redis ìºì‹± ì „ëµ
   - ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ìµœì í™”
   - N+1 ë¬¸ì œ í•´ê²°

3. **ëª¨ë‹ˆí„°ë§ ê°•í™”**:
   - ë©”íŠ¸ë¦­ ìˆ˜ì§‘
   - ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ
   - ì•ŒëŒ ì„¤ì •

4. **í”„ë¡œë•ì…˜ ì¤€ë¹„**:
   - ë¡œë“œ í…ŒìŠ¤íŠ¸
   - ë³´ì•ˆ ê°ì‚¬
   - ë°°í¬ ìë™í™”

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

1. [ê°œë°œê³„íšì„œ (ë©”ì¸)](./ê°œë°œê³„íšì„œ_2025_10_24_ì—…ë°ì´íŠ¸.md)
2. [PRD ë¬¸ì„œ](./1.%20PRD_ì¤‘ê³ ê±°ë˜ì‚¬ì´íŠ¸_ë°±ì—”ë“œ.md)
3. [Prisma ìŠ¤í‚¤ë§ˆ](../prisma/schema.prisma)
4. [Phase 3 ì™„ë£Œ ë³´ê³ ì„œ](ë©”ëª¨ë¦¬: session_checkpoint_phase3_progress)

---

**ë¬¸ì„œ ë²„ì „**: v1.0
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-11-18
**ì‘ì„±ì**: ê°œë°œíŒ€
**ë‹¤ìŒ ì—…ë°ì´íŠ¸**: Week 11 ì¢…ë£Œ ì‹œ
