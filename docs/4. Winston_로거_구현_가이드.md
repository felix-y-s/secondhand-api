# Winston 로거 구현 가이드

## 📋 문서 정보

- **프로젝트**: 중고거래사이트 백엔드 API
- **작성일**: 2025-10-15
- **목적**: Winston 로거 도입 가이드 및 구현 방법

---

## 🎯 Winston 로거 도입 필요성

### 핵심 이유

#### 1. 거래 추적성 (Audit Trail) 필수
중고거래 플랫폼의 법적 요구사항:
- 모든 거래 과정 기록 보관
- 분쟁 해결을 위한 증거 보전
- 전자상거래법 준수

#### 2. 컴플라이언스 (Compliance)
- **GDPR**: 개인정보 처리 기록 보관
- **PCI DSS**: 결제 데이터 처리 로그 보안
- **개인정보보호법**: 접근 기록 및 처리 내역

#### 3. 사기 탐지 및 보안
- 이상 패턴 감지를 위한 로그 분석
- 실시간 위협 모니터링
- 보안 감사 (Security Audit)

#### 4. 프로덕션 안정성
- 장애 발생 시 빠른 원인 파악
- 성능 병목 지점 분석
- 시스템 헬스 모니터링

---

## 📊 NestJS 기본 Logger vs Winston 비교

| 기능 | NestJS Logger | Winston |
|------|---------------|---------|
| **파일 저장** | ❌ 콘솔만 | ✅ 파일, 로테이션 |
| **로그 레벨** | ✅ 기본 지원 | ✅ 세밀한 제어 |
| **JSON 포맷** | ⚠️ 제한적 | ✅ 완전한 구조화 |
| **외부 연동** | ❌ | ✅ ELK, CloudWatch, Loggly |
| **로테이션** | ❌ | ✅ 일별/크기별 |
| **민감정보 마스킹** | ❌ 수동 | ✅ 자동화 가능 |
| **성능** | ✅ 빠름 | ✅ 비동기 처리 |
| **NestJS 통합** | ✅ 완벽 | ✅ nest-winston |
| **프로덕션 검증** | ⚠️ 기본 | ✅ 업계 표준 |

### 결론
**Winston 도입 적극 권장** ✅

---

## 🔧 구현 단계

### Step 1: 패키지 설치

```bash
# Winston 및 NestJS 통합
pnpm add winston nest-winston

# 로그 로테이션
pnpm add winston-daily-rotate-file

# 타입 정의
pnpm add -D @types/node
```

---

### Step 2: Winston 설정 모듈 생성

#### 2.1 로거 설정 파일

```typescript
// src/config/logger.config.ts
import { WinstonModuleOptions } from 'nest-winston';
import * as winston from 'winston';
import * as DailyRotateFile from 'winston-daily-rotate-file';
import { utilities as nestWinstonModuleUtilities } from 'nest-winston';

/**
 * 민감정보 마스킹 함수
 */
const maskSensitiveData = winston.format((info) => {
  const message = JSON.stringify(info);

  // 비밀번호 마스킹
  info.message = message
    .replace(/"password":\s*"[^"]*"/g, '"password": "****"')
    .replace(/"passwordHash":\s*"[^"]*"/g, '"passwordHash": "****"')
    // 카드 번호 마스킹
    .replace(/\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}/g, '****-****-****-****')
    // 이메일 부분 마스킹
    .replace(/([a-zA-Z0-9._-]+)@/g, '***@')
    // 전화번호 마스킹
    .replace(/\d{3}[-\s]?\d{3,4}[-\s]?\d{4}/g, '***-****-****');

  return info;
});

/**
 * Winston 로거 설정
 */
export const winstonConfig: WinstonModuleOptions = {
  transports: [
    // 콘솔 출력 (개발 환경)
    new winston.transports.Console({
      level: process.env.NODE_ENV === 'production' ? 'info' : 'debug',
      format: winston.format.combine(
        winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
        winston.format.ms(),
        nestWinstonModuleUtilities.format.nestLike('SecondhandAPI', {
          colors: true,
          prettyPrint: true,
        }),
      ),
    }),

    // 에러 로그 파일 (프로덕션)
    new DailyRotateFile({
      level: 'error',
      dirname: 'logs',
      filename: 'error-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      zippedArchive: true,
      maxSize: '20m',
      maxFiles: '14d',
      format: winston.format.combine(
        winston.format.timestamp(),
        maskSensitiveData(),
        winston.format.json(),
      ),
    }),

    // 전체 로그 파일 (프로덕션)
    new DailyRotateFile({
      level: 'info',
      dirname: 'logs',
      filename: 'combined-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      zippedArchive: true,
      maxSize: '20m',
      maxFiles: '14d',
      format: winston.format.combine(
        winston.format.timestamp(),
        maskSensitiveData(),
        winston.format.json(),
      ),
    }),

    // 거래 로그 파일 (별도 보관)
    new DailyRotateFile({
      level: 'info',
      dirname: 'logs/transactions',
      filename: 'transaction-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      zippedArchive: true,
      maxSize: '50m',
      maxFiles: '30d', // 30일 보관
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json(),
      ),
    }),

    // 디버그 로그 (개발 환경만)
    ...(process.env.NODE_ENV !== 'production'
      ? [
          new DailyRotateFile({
            level: 'debug',
            dirname: 'logs',
            filename: 'debug-%DATE%.log',
            datePattern: 'YYYY-MM-DD',
            maxSize: '20m',
            maxFiles: '3d',
            format: winston.format.combine(
              winston.format.timestamp(),
              winston.format.json(),
            ),
          }),
        ]
      : []),
  ],

  // 예외 및 거부된 프로미스 처리
  exceptionHandlers: [
    new DailyRotateFile({
      dirname: 'logs',
      filename: 'exceptions-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxSize: '20m',
      maxFiles: '14d',
    }),
  ],

  rejectionHandlers: [
    new DailyRotateFile({
      dirname: 'logs',
      filename: 'rejections-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxSize: '20m',
      maxFiles: '14d',
    }),
  ],
};
```

---

### Step 3: AppModule에 Winston 통합

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { WinstonModule } from 'nest-winston';
import { winstonConfig } from './config/logger.config';
import databaseConfig from './config/database.config';
import jwtConfig from './config/jwt.config';
import appConfig from './config/app.config';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      load: [databaseConfig, jwtConfig, appConfig],
    }),

    // Winston 로거 글로벌 모듈로 등록
    WinstonModule.forRoot(winstonConfig),

    // 다른 모듈들...
  ],
})
export class AppModule {}
```

---

### Step 4: main.ts에서 Winston 로거 적용

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { ValidationPipe, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { WINSTON_MODULE_NEST_PROVIDER } from 'nest-winston';
import * as compression from 'compression';
import helmet from 'helmet';
import { AllExceptionsFilter } from './common/filters/http-exception.filter';
import { TransformInterceptor } from './common/interceptors/transform.interceptor';
import { LoggingInterceptor } from './common/interceptors/logging.interceptor';
import { setupSwagger } from './config/swagger.config';

async function bootstrap() {
  const app = await NestFactory.create(AppModule, {
    bufferLogs: true, // Winston이 로그를 버퍼링할 수 있도록 설정
  });

  // Winston 로거를 애플리케이션 로거로 설정
  app.useLogger(app.get(WINSTON_MODULE_NEST_PROVIDER));

  const configService = app.get(ConfigService);
  const logger = new Logger('Bootstrap');

  // 보안 미들웨어
  app.use(helmet());
  app.use(compression());

  // CORS 설정
  app.enableCors({
    origin: configService.get<string[]>('app.corsOrigins'),
    credentials: true,
  });

  // 글로벌 프리픽스
  app.setGlobalPrefix(configService.get<string>('app.apiPrefix'));

  // 글로벌 파이프
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
      transformOptions: {
        enableImplicitConversion: true,
      },
    }),
  );

  // 글로벌 필터
  app.useGlobalFilters(new AllExceptionsFilter());

  // 글로벌 인터셉터
  app.useGlobalInterceptors(
    new LoggingInterceptor(),
    new TransformInterceptor(),
  );

  // Swagger 설정
  setupSwagger(app);

  const port = configService.get<number>('app.port');
  await app.listen(port);

  logger.log(`🚀 Application is running on: http://localhost:${port}`);
  logger.log(`📚 API Documentation: http://localhost:${port}/api-docs`);
  logger.log(`🌍 Environment: ${configService.get<string>('app.nodeEnv')}`);
}

bootstrap();
```

---

### Step 5: 서비스에서 Winston 로거 사용

```typescript
// src/modules/users/users.service.ts
import { Injectable, Inject, LoggerService } from '@nestjs/common';
import { WINSTON_MODULE_NEST_PROVIDER } from 'nest-winston';
import { PrismaService } from '../../prisma/prisma.service';

@Injectable()
export class UsersService {
  constructor(
    @Inject(WINSTON_MODULE_NEST_PROVIDER)
    private readonly logger: LoggerService,
    private readonly prisma: PrismaService,
  ) {}

  async findOne(id: number) {
    this.logger.log(`사용자 조회 시작: userId=${id}`, 'UsersService');

    try {
      const user = await this.prisma.user.findUnique({
        where: { id },
      });

      if (!user) {
        this.logger.warn(`사용자를 찾을 수 없음: userId=${id}`, 'UsersService');
        return null;
      }

      this.logger.log(
        `사용자 조회 완료: userId=${id}, email=${user.email}`,
        'UsersService',
      );

      return user;
    } catch (error) {
      this.logger.error(
        `사용자 조회 실패: userId=${id}, error=${error.message}`,
        error.stack,
        'UsersService',
      );
      throw error;
    }
  }

  async create(data: CreateUserDto) {
    this.logger.log(
      `사용자 생성 시작: email=${data.email}`,
      'UsersService',
    );

    try {
      const user = await this.prisma.user.create({
        data: {
          email: data.email,
          passwordHash: data.password, // 실제로는 해싱 필요
        },
      });

      this.logger.log(
        `사용자 생성 완료: userId=${user.id}, email=${user.email}`,
        'UsersService',
      );

      return user;
    } catch (error) {
      this.logger.error(
        `사용자 생성 실패: email=${data.email}, error=${error.message}`,
        error.stack,
        'UsersService',
      );
      throw error;
    }
  }
}
```

---

### Step 6: 거래 전용 로거 서비스

```typescript
// src/shared/services/transaction-logger.service.ts
import { Injectable, Inject, LoggerService } from '@nestjs/common';
import { WINSTON_MODULE_NEST_PROVIDER } from 'nest-winston';

export interface TransactionLog {
  transactionId: string;
  type: 'ORDER' | 'PAYMENT' | 'SHIPMENT' | 'REFUND';
  userId: number;
  orderId?: number;
  amount?: number;
  status: string;
  metadata?: Record<string, any>;
}

@Injectable()
export class TransactionLoggerService {
  constructor(
    @Inject(WINSTON_MODULE_NEST_PROVIDER)
    private readonly logger: LoggerService,
  ) {}

  /**
   * 거래 로그 기록 (별도 파일에 저장)
   */
  logTransaction(log: TransactionLog): void {
    const logMessage = {
      timestamp: new Date().toISOString(),
      ...log,
    };

    // 'transaction' 컨텍스트로 로깅하면 별도 파일에 저장됨
    this.logger.log(
      JSON.stringify(logMessage),
      'TransactionLogger',
    );
  }

  /**
   * 주문 생성 로그
   */
  logOrderCreated(orderId: number, userId: number, amount: number): void {
    this.logTransaction({
      transactionId: `ORDER-${orderId}-${Date.now()}`,
      type: 'ORDER',
      userId,
      orderId,
      amount,
      status: 'CREATED',
    });
  }

  /**
   * 결제 완료 로그
   */
  logPaymentCompleted(
    orderId: number,
    userId: number,
    amount: number,
    paymentMethod: string,
  ): void {
    this.logTransaction({
      transactionId: `PAY-${orderId}-${Date.now()}`,
      type: 'PAYMENT',
      userId,
      orderId,
      amount,
      status: 'COMPLETED',
      metadata: { paymentMethod },
    });
  }

  /**
   * 환불 로그
   */
  logRefund(
    orderId: number,
    userId: number,
    amount: number,
    reason: string,
  ): void {
    this.logTransaction({
      transactionId: `REFUND-${orderId}-${Date.now()}`,
      type: 'REFUND',
      userId,
      orderId,
      amount,
      status: 'REFUNDED',
      metadata: { reason },
    });
  }
}
```

---

### Step 7: HTTP 요청 로깅 인터셉터 업데이트

```typescript
// src/common/interceptors/logging.interceptor.ts
import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
  Inject,
  LoggerService,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';
import { WINSTON_MODULE_NEST_PROVIDER } from 'nest-winston';

@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  constructor(
    @Inject(WINSTON_MODULE_NEST_PROVIDER)
    private readonly logger: LoggerService,
  ) {}

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest();
    const method = request.method;
    const url = request.url;
    const userId = request.user?.userId || 'anonymous';
    const now = Date.now();

    // 요청 시작 로그
    this.logger.log(
      `📥 [${method}] ${url} - User: ${userId}`,
      'HTTP',
    );

    return next.handle().pipe(
      tap({
        next: () => {
          const response = context.switchToHttp().getResponse();
          const statusCode = response.statusCode;
          const delay = Date.now() - now;

          // 응답 성공 로그
          this.logger.log(
            `📤 [${method}] ${url} ${statusCode} - ${delay}ms - User: ${userId}`,
            'HTTP',
          );
        },
        error: (error) => {
          const delay = Date.now() - now;

          // 응답 에러 로그
          this.logger.error(
            `❌ [${method}] ${url} ${error.status || 500} - ${delay}ms - User: ${userId}`,
            error.stack,
            'HTTP',
          );
        },
      }),
    );
  }
}
```

---

## 📂 로그 파일 구조

```
logs/
├── combined-2025-10-15.log      # 전체 로그 (info 이상)
├── error-2025-10-15.log          # 에러 로그만
├── debug-2025-10-15.log          # 디버그 로그 (개발 환경)
├── exceptions-2025-10-15.log     # 예외 처리되지 않은 에러
├── rejections-2025-10-15.log     # Promise rejection
└── transactions/
    └── transaction-2025-10-15.log # 거래 로그 (별도 보관)
```

---

## 🔒 보안 및 컴플라이언스

### 1. 민감정보 마스킹

Winston 설정에 포함된 `maskSensitiveData` 포맷으로 자동 마스킹:
- 비밀번호
- 카드 번호
- 이메일 (부분 마스킹)
- 전화번호

### 2. 로그 보관 정책

| 로그 타입 | 보관 기간 | 이유 |
|-----------|-----------|------|
| 거래 로그 | 30일 | 전자상거래법 요구사항 |
| 에러 로그 | 14일 | 장애 분석 |
| 전체 로그 | 14일 | 시스템 모니터링 |
| 디버그 로그 | 3일 | 개발 디버깅 |

### 3. 접근 권한 제어

```bash
# 로그 파일 권한 설정
chmod 640 logs/*.log
chown appuser:appgroup logs/*.log

# 거래 로그는 더 엄격하게
chmod 600 logs/transactions/*.log
```

---

## 📊 성능 고려사항

### 1. 비동기 파일 쓰기
Winston은 기본적으로 비동기로 ���일을 작성하여 애플리케이션 성능에 최소 영향

### 2. 로그 레벨 최적화

**개발 환경:**
```typescript
level: 'debug'  // 모든 로그 출력
```

**프로덕션 환경:**
```typescript
level: 'info'   // info 이상만 출력 (debug 제외)
```

### 3. 파일 로테이션

- **일별 로테이션**: 매일 자정에 새 파일 생성
- **크기별 로테이션**: 20MB 초과 시 새 파일 생성
- **압축**: 오래된 로그는 gzip 압축
- **자동 삭제**: 보관 기간 초과 로그 자동 삭제

---

## 🔗 외부 서비스 연동 준비

### 1. Elasticsearch 연동 (향후)

```bash
pnpm add winston-elasticsearch
```

```typescript
// winston-elasticsearch transport 추가
import { ElasticsearchTransport } from 'winston-elasticsearch';

new ElasticsearchTransport({
  level: 'info',
  clientOpts: {
    node: 'http://localhost:9200',
  },
  index: 'secondhand-logs',
})
```

### 2. AWS CloudWatch 연동 (향후)

```bash
pnpm add winston-cloudwatch
```

---

## ✅ 검증 및 테스트

### 1. 로그 생성 확인

```bash
# 애플리케이션 시작
pnpm run start:dev

# 로그 디렉토리 확인
ls -la logs/

# 실시간 로그 확인
tail -f logs/combined-$(date +%Y-%m-%d).log
```

### 2. 로그 포맷 확인

```bash
# JSON 포맷 확인
cat logs/combined-$(date +%Y-%m-%d).log | jq
```

### 3. 민감정보 마스킹 테스트

```typescript
// 테스트 코드
this.logger.log('User password: mypassword123');
// 출력: User password: ****

this.logger.log('Card: 1234-5678-9012-3456');
// 출력: Card: ****-****-****-****
```

---

## 📋 구현 체크리스트

### Phase 1 (Week 1-2) - 기본 설정
- [ ] winston, nest-winston 패키지 설치
- [ ] winston-daily-rotate-file 설치
- [ ] logger.config.ts 작성
- [ ] AppModule에 Winston 통합
- [ ] main.ts에서 Winston 로거 적용
- [ ] 로그 디렉토리 생성 및 권한 설정
- [ ] .gitignore에 logs/ 추가

### Phase 1 (Week 3-4) - 고급 기능
- [ ] 민감정보 마스킹 함수 구현
- [ ] 거래 전용 로거 서비스 작성
- [ ] HTTP 요청 로깅 인터셉터 업데이트
- [ ] 예외 처리 로깅
- [ ] 로그 로테이션 테스트

### Phase 2-3 - 통합 및 모니터링
- [ ] 각 모듈에 Winston 로거 적용
- [ ] 거래 로그 분석 스크립트
- [ ] Elasticsearch 연동 (선택)
- [ ] CloudWatch 연동 (선택)
- [ ] 알림 시스템 통합

---

## 🚀 즉시 시작하기

### 1단계: 패키지 설치
```bash
pnpm add winston nest-winston winston-daily-rotate-file
```

### 2단계: 설정 파일 복사
위의 `logger.config.ts` 코드를 `src/config/logger.config.ts`에 생성

### 3단계: AppModule 업데이트
위의 `app.module.ts` 코드로 Winston 모듈 추가

### 4단계: main.ts 업데이트
`app.useLogger(app.get(WINSTON_MODULE_NEST_PROVIDER))` 추가

### 5단계: 로그 디렉토리 생성
```bash
mkdir -p logs/transactions
```

### 6단계: .gitignore 업데이트
```bash
echo "logs/" >> .gitignore
```

### 7단계: 애플리케이션 시작 및 테스트
```bash
pnpm run start:dev
```

---

## 💡 모범 사례

### 1. 로그 레벨 사용 가이드

- **error**: 애플리케이션 오류 (즉시 조치 필요)
- **warn**: 잠재적 문제 (모니터링 필요)
- **info**: 중요한 비즈니스 이벤트
- **http**: HTTP 요청/응답
- **debug**: 상세한 디버깅 정보 (개발 환경만)

### 2. 구조화된 로그 메시지

```typescript
// ❌ 나쁜 예
this.logger.log('User created');

// ✅ 좋은 예
this.logger.log(
  `사용자 생성 완료: userId=${user.id}, email=${user.email}`,
  'UsersService',
);
```

### 3. 에러 로깅

```typescript
try {
  // 작업 수행
} catch (error) {
  this.logger.error(
    `작업 실패: ${error.message}`,
    error.stack,
    'ServiceName',
  );
  throw error;
}
```

---

## 📈 다음 단계

1. **Phase 1 완료 후**: 모든 모듈에 Winston 로거 적용
2. **Phase 2**: 거래 로그 분석 대시보드 구축
3. **Phase 3**: Elasticsearch + Kibana 연동
4. **Phase 4**: 실시간 알림 시스템 통합

---

**문서 버전**: v1.0
**최종 업데이트**: 2025-10-15
**작성자**: 개발팀
