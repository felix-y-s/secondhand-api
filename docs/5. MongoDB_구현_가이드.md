# MongoDB êµ¬í˜„ ê°€ì´ë“œ

**ì‘ì„±ì¼**: 2025-12-03 (v1.1 ê°œì„ )
**ëŒ€ìƒ í”„ë¡œì íŠ¸**: Secondhand API (NestJS + Mongoose + MongoDB)
**ëª©ì **: Messages ëª¨ë“ˆ ë° í™•ì¥ ë°ì´í„°ë¥¼ ìœ„í•œ MongoDB í†µí•© êµ¬í˜„

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [MongoDB vs PostgreSQL ì„ íƒ ê¸°ì¤€](#mongodb-vs-postgresql-ì„ íƒ-ê¸°ì¤€)
3. [ì„¤ì¹˜ ë° ì„¤ì •](#ì„¤ì¹˜-ë°-ì„¤ì •)
4. [Mongoose ìŠ¤í‚¤ë§ˆ ì„¤ê³„](#mongoose-ìŠ¤í‚¤ë§ˆ-ì„¤ê³„)
5. [NestJS ëª¨ë“ˆ êµ¬ì„±](#nestjs-ëª¨ë“ˆ-êµ¬ì„±)
6. [Repository íŒ¨í„´ êµ¬í˜„](#repository-íŒ¨í„´-êµ¬í˜„)
7. [Messages ëª¨ë“ˆ êµ¬í˜„ ì˜ˆì‹œ](#messages-ëª¨ë“ˆ-êµ¬í˜„-ì˜ˆì‹œ)
8. [í…ŒìŠ¤íŠ¸ ì „ëµ](#í…ŒìŠ¤íŠ¸-ì „ëµ)
9. [ì„±ëŠ¥ ìµœì í™”](#ì„±ëŠ¥-ìµœì í™”)
10. [í¬ë¡œìŠ¤ DB íŠ¸ëœì­ì…˜ ì²˜ë¦¬](#í¬ë¡œìŠ¤-db-íŠ¸ëœì­ì…˜-ì²˜ë¦¬)
11. [ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ë™ê¸°í™”](#ë§ˆì´ê·¸ë ˆì´ì…˜-ë°-ë™ê¸°í™”)

---

## ê°œìš”

### ì™œ MongoDBë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?

**Messages ëª¨ë“ˆì˜ íŠ¹ì„±**:
- ë¹ ë¥¸ ì“°ê¸° ì‘ì—… (ì‹¤ì‹œê°„ ì±„íŒ…)
- ìœ ì—°í•œ ìŠ¤í‚¤ë§ˆ (ë©”ì‹œì§€ ë©”íƒ€ë°ì´í„° í™•ì¥ì„±)
- ì½ê¸° ì¤‘ì‹¬ ì¿¼ë¦¬ (ì±„íŒ… íˆìŠ¤í† ë¦¬ ì¡°íšŒ)
- ëŒ€ìš©ëŸ‰ ë°ì´í„° (ëˆ„ì ë˜ëŠ” ë©”ì‹œì§€)

**MongoDBì˜ ì¥ì **:
- âœ… ë¹ ë¥¸ ì“°ê¸° ì„±ëŠ¥ (ì±„íŒ…ì— ìµœì )
- âœ… ìœ ì—°í•œ ë¬¸ì„œ êµ¬ì¡° (ë©”íƒ€ë°ì´í„° í™•ì¥ ìš©ì´)
- âœ… ìˆ˜í‰ í™•ì¥ ìš©ì´ (ìƒ¤ë”©)
- âœ… ì‹œê³„ì—´ ë°ì´í„°ì— ì í•© (ë©”ì‹œì§€ íƒ€ì„ìŠ¤íƒ¬í”„)

---

## MongoDB vs PostgreSQL ì„ íƒ ê¸°ì¤€

### ì‚¬ìš© ì‚¬ë¡€ë³„ ê¶Œì¥ì‚¬í•­

| ëª¨ë“ˆ | ì¶”ì²œ DB | ì´ìœ  |
|------|---------|------|
| **Messages** | MongoDB | ë¹ ë¥¸ ì“°ê¸°, ìœ ì—°í•œ ìŠ¤í‚¤ë§ˆ, ì‹œê³„ì—´ ë°ì´í„° |
| **ProductDetails** | MongoDB | ë¹„ì •í˜• ë°ì´í„°(ì´ë¯¸ì§€, ìŠ¤í™), ìœ„ì¹˜ ì •ë³´ |
| **Notifications** | PostgreSQL | íŠ¸ëœì­ì…˜, ê´€ê³„í˜• ë°ì´í„°, ì¼ê´€ì„± ì¤‘ìš” |
| Users, Products, Orders | PostgreSQL | íŠ¸ëœì­ì…˜, ë¬´ê²°ì„±, ë³µì¡í•œ ê´€ê³„ |

### MongoDBë¥¼ ì„ íƒí•´ì•¼ í•  ë•Œ

âœ… **ì±„íŒ…/ë©”ì‹œì§• ì‹œìŠ¤í…œ**
âœ… **ë¡œê·¸/ì´ë²¤íŠ¸ ì €ì¥ì†Œ**
âœ… **ì‹¤ì‹œê°„ ë°ì´í„° ìŠ¤íŠ¸ë¦¼**
âœ… **ë¹„ì •í˜• ë°ì´í„° ì €ì¥ (ìƒí’ˆ ìƒì„¸ ìŠ¤í™ ë“±)**
âœ… **ìœ„ì¹˜ ê¸°ë°˜ ê²€ìƒ‰ (GeoJSON)**

### PostgreSQLì„ ì„ íƒí•´ì•¼ í•  ë•Œ

âœ… **íŠ¸ëœì­ì…˜ í•„ìˆ˜**
âœ… **ë³µì¡í•œ JOIN ì¿¼ë¦¬**
âœ… **ë°ì´í„° ë¬´ê²°ì„± ì¤‘ìš”**
âœ… **ACID ë³´ì¥ í•„ìš”**
âœ… **êµ¬ì¡°í™”ëœ ê´€ê³„í˜• ë°ì´í„°**

---

## ì„¤ì¹˜ ë° ì„¤ì •

### 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
npm install @nestjs/mongoose mongoose
npm install -D @types/mongoose
```

### 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

**.env**:
```env
# MongoDB ì—°ê²° ë¬¸ìì—´
# ë¡œì»¬ ê°œë°œ
MONGODB_URI="mongodb://localhost:27017/secondhand"

# í”„ë¡œë•ì…˜ (MongoDB Atlas ì˜ˆì‹œ)
# MONGODB_URI="mongodb+srv://username:password@cluster.mongodb.net/secondhand?retryWrites=true&w=majority"
```

### 3. Config ì„¤ì •

**âœ… ì´ë¯¸ í”„ë¡œì íŠ¸ì— ì„¤ì •ë˜ì–´ ìˆìŒ** ([src/config/configuration.ts:44-46](src/config/configuration.ts:44-46)):
```typescript
export default () => ({
  // ... ê¸°íƒ€ ì„¤ì •
  database: {
    postgres: {
      // PostgreSQL ì„¤ì •
    },
    mongodb: {
      uri: process.env.MONGODB_URI || 'mongodb://localhost:27017/secondhand_db',
    },
    // ... Redis, ë“±
  },
});
```

**ì‚¬ìš© ë°©ë²•**:
```typescript
// ConfigServiceë¡œ MongoDB URI ê°€ì ¸ì˜¤ê¸°
constructor(private configService: ConfigService) {}

const mongoUri = this.configService.get<string>('database.mongodb.uri');
```

---

## Mongoose ìŠ¤í‚¤ë§ˆ ì„¤ê³„

### í•µì‹¬ ê°œë…

**Mongoose 6+ ê¶Œì¥ íŒ¨í„´**:
- `Document` ìƒì† ëŒ€ì‹  ìˆœìˆ˜ í´ë˜ìŠ¤ + `HydratedDocument` íƒ€ì… ì‚¬ìš©
- ëª…ì‹œì  íƒ€ì… ì§€ì • (`@Prop({ type: Number })`)
- TypeScript íƒ€ì… ì•ˆì •ì„± í–¥ìƒ

### ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ êµ¬ì¡°

**src/database/mongodb/schemas/message.schema.ts**:
```typescript
import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { HydratedDocument } from 'mongoose';

// Mongoose Document íƒ€ì… ì •ì˜
export type MessageDocument = HydratedDocument<Message>;

@Schema({ collection: 'messages', timestamps: true })
export class Message {
  // ëŒ€í™”ë°© ID (ChatRoom ObjectID)
  @Prop({ required: true, type: String, index: true })
  conversationId: string;

  // ë°œì‹ ì ID (PostgreSQLì˜ User ID)
  @Prop({ required: true, type: Number, index: true })
  senderId: number;

  // ìˆ˜ì‹ ì ID (PostgreSQLì˜ User ID)
  @Prop({ required: true, type: Number, index: true })
  receiverId: number;

  // ë©”ì‹œì§€ ë‚´ìš©
  @Prop({ required: true })
  message: string;

  // ë©”ì‹œì§€ íƒ€ì…
  @Prop({
    type: String,
    enum: ['text', 'image', 'system'],
    default: 'text'
  })
  messageType: 'text' | 'image' | 'system';

  // ì½ìŒ ì‹œê°„
  @Prop({ type: Date })
  readAt?: Date;

  // timestamps: trueë¡œ ìë™ ìƒì„±ë˜ëŠ” í•„ë“œë“¤ (íƒ€ì… ëª…ì‹œ)
  createdAt: Date;
  updatedAt: Date;
}

export const MessageSchema = SchemaFactory.createForClass(Message);

// ë³µí•© ì¸ë±ìŠ¤ (conversationId + createdAt ì¡°í•© ì¿¼ë¦¬ ìµœì í™”)
MessageSchema.index({ conversationId: 1, createdAt: -1 });

// ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¡°íšŒ ìµœì í™” (ë¶€ë¶„ ì¸ë±ìŠ¤)
MessageSchema.index(
  { receiverId: 1, readAt: 1 },
  { partialFilterExpression: { readAt: null } }
);
```

**ê°œì„  í¬ì¸íŠ¸**:
1. âœ… `HydratedDocument<Message>` íƒ€ì… ì‚¬ìš© (Mongoose 6+)
2. âœ… `@Prop({ type: Number })` ëª…ì‹œì  íƒ€ì… ì§€ì •
3. âœ… `messageType`ì— Union íƒ€ì… ì ìš©
4. âœ… `timestamps` í•„ë“œ íƒ€ì… ëª…ì‹œ
5. âœ… ë¶€ë¶„ ì¸ë±ìŠ¤ë¡œ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¿¼ë¦¬ ìµœì í™”

**src/database/mongodb/schemas/product-detail.schema.ts**:
```typescript
import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { HydratedDocument } from 'mongoose';

export type ProductDetailDocument = HydratedDocument<ProductDetail>;

@Schema({ collection: 'product_details', timestamps: true })
export class ProductDetail {
  // PostgreSQLì˜ Product IDì™€ ì—°ê²°
  @Prop({ required: true, unique: true, type: Number })
  productId: number;

  // ìƒì„¸ ì„¤ëª… (ë§ˆí¬ë‹¤ìš´ ì§€ì›)
  @Prop({ required: true })
  description: string;

  // ì´ë¯¸ì§€ ë°°ì—´
  @Prop({
    type: [{
      url: { type: String, required: true },
      alt: { type: String },
      order: { type: Number, required: true }
    }]
  })
  images: Array<{ url: string; alt?: string; order: number }>;

  // ìƒí’ˆ ìƒì„¸ ìŠ¤í™ (ìœ ì—°í•œ êµ¬ì¡°)
  @Prop({ type: Object })
  specifications: Record<string, any>;

  // ìœ„ì¹˜ ì •ë³´ (GeoJSON)
  @Prop({
    type: {
      type: { type: String, enum: ['Point'], required: true },
      coordinates: { type: [Number], required: true }
    }
  })
  location?: {
    type: 'Point';
    coordinates: [number, number]; // [ê²½ë„, ìœ„ë„]
  };

  createdAt: Date;
  updatedAt: Date;
}

export const ProductDetailSchema = SchemaFactory.createForClass(ProductDetail);

// productIdë¡œ ì¡°íšŒ ìµœì í™” (ì´ë¯¸ unique: true)
ProductDetailSchema.index({ productId: 1 });

// 2dsphere ì¸ë±ìŠ¤ (ìœ„ì¹˜ ê¸°ë°˜ ê²€ìƒ‰ìš©)
ProductDetailSchema.index({ location: '2dsphere' });
```

**ìœ„ì¹˜ ê¸°ë°˜ ê²€ìƒ‰ ì˜ˆì‹œ**:
```typescript
// ë°˜ê²½ 5km ì´ë‚´ ìƒí’ˆ ê²€ìƒ‰
const nearbyProducts = await this.productDetailModel.find({
  location: {
    $near: {
      $geometry: {
        type: 'Point',
        coordinates: [127.0276, 37.4979], // [ê²½ë„, ìœ„ë„]
      },
      $maxDistance: 5000, // 5km (ë¯¸í„° ë‹¨ìœ„)
    },
  },
});
```

---

### ChatRoom ìŠ¤í‚¤ë§ˆ (ì‹ ê·œ ì¶”ê°€)

ì±„íŒ…ë°© ëª©ë¡ ê´€ë¦¬ì™€ "ì±„íŒ…ë°© ë‚˜ê°€ê¸°" ê¸°ëŠ¥ì„ ìœ„í•´ ë³„ë„ì˜ `ChatRoom` ì»¬ë ‰ì…˜ì„ ìš´ìš©í•©ë‹ˆë‹¤.

**src/database/mongodb/schemas/chat-room.schema.ts**:
```typescript
import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { HydratedDocument, Types } from 'mongoose';

export type ChatRoomDocument = HydratedDocument<ChatRoom>;

@Schema({ collection: 'chat_rooms', timestamps: true })
export class ChatRoom {
  // ì°¸ì—¬ì ëª©ë¡ (ìƒíƒœ ê´€ë¦¬ í¬í•¨)
  @Prop({
    type: [{
      userId: { type: Number, required: true }, // PostgreSQL User ID
      joinedAt: { type: Date, default: Date.now },
      leftAt: { type: Date, default: null }, // ë‚˜ê°„ ì‹œê°„ (nullì´ë©´ ì°¸ì—¬ ì¤‘)
    }],
    _id: false // ì„œë¸Œë… ID ìƒì„± ë°©ì§€
  })
  participants: { userId: number; joinedAt: Date; leftAt?: Date }[];

  // ê´€ë ¨ ìƒí’ˆ ID (ì¤‘ê³ ì¥í„° íŠ¹ì„±ìƒ ìƒí’ˆë³„ ì±„íŒ…ë°© ë¶„ë¦¬ í•„ìˆ˜)
  @Prop({ required: true, type: Number, index: true })
  productId: number;

  // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë‚´ìš© (ëª©ë¡ ì¡°íšŒ ìµœì í™”ìš© - ë¯¸ë¦¬ë³´ê¸°)
  @Prop()
  lastMessage?: string;

  // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ID (ì»¤ì„œ í˜ì´ì§•ìš©)
  @Prop({ type: Types.ObjectId })
  lastMessageId?: Types.ObjectId;

  // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ (ì •ë ¬ìš©)
  @Prop({ index: true })
  lastMessageAt?: Date;

  createdAt: Date;
  updatedAt: Date;
}

export const ChatRoomSchema = SchemaFactory.createForClass(ChatRoom);

// ë‚´ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ë° ì •ë ¬ ìµœì í™” (Compound Index)
// ESR (Equality, Sort, Range) ê·œì¹™ ì ìš©:
// 1. Equality: participants.userId, participants.leftAt
// 2. Sort: lastMessageAt
ChatRoomSchema.index({ 
  'participants.userId': 1, 
  'participants.leftAt': 1, 
  lastMessageAt: -1 
});
```

---

## NestJS ëª¨ë“ˆ êµ¬ì„±

### MongoDB Module

**src/database/mongodb/mongodb.module.ts**:
```typescript
import { Module } from '@nestjs/common';
import { MongooseModule } from '@nestjs/mongoose';
import { ConfigService } from '@nestjs/config';
import { Message, MessageSchema } from './schemas/message.schema';
import { ProductDetail, ProductDetailSchema } from './schemas/product-detail.schema';

@Module({
  imports: [
    // ë¹„ë™ê¸° ì„¤ì • ë¡œë”© + ì—°ê²° í’€ë§ + ì—ëŸ¬ í•¸ë“¤ë§
    MongooseModule.forRootAsync({
      inject: [ConfigService],
      useFactory: (configService: ConfigService) => ({
        uri: configService.get<string>('database.mongodb.uri'),
        // ì—°ê²° í’€ë§ ì„¤ì •
        maxPoolSize: 10,
        minPoolSize: 2,
        socketTimeoutMS: 45000,
        serverSelectionTimeoutMS: 5000,
        // ì—°ê²° ì´ë²¤íŠ¸ í•¸ë“¤ë§
        connectionFactory: (connection) => {
          connection.on('connected', () => {
            console.log('âœ… MongoDB ì—°ê²° ì„±ê³µ');
          });
          connection.on('error', (error) => {
            console.error('âŒ MongoDB ì—°ê²° ì˜¤ë¥˜:', error);
          });
          connection.on('disconnected', () => {
            console.log('âš ï¸ MongoDB ì—°ê²° ëŠê¹€');
          });
          return connection;
        },
      }),
    }),
    // ìŠ¤í‚¤ë§ˆ ë“±ë¡ (ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ exports í•„ìš”)
    MongooseModule.forFeature([
      { name: Message.name, schema: MessageSchema },
      { name: ProductDetail.name, schema: ProductDetailSchema },
      { name: ChatRoom.name, schema: ChatRoomSchema },
    ]),
    ]),
  ],
  exports: [MongooseModule], // ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ ìŠ¤í‚¤ë§ˆ ì‚¬ìš© ê°€ëŠ¥
})
export class MongodbModule {}
```

**AppModuleì— ë“±ë¡**:
```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { MongodbModule } from './database/mongodb/mongodb.module';
import configuration from './config/configuration';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      load: [configuration],
    }),
    MongodbModule, // MongoDB ëª¨ë“ˆ ë“±ë¡
    // ... ê¸°íƒ€ ëª¨ë“ˆ
  ],
})
export class AppModule {}
```

**ê°œì„  í¬ì¸íŠ¸**:
1. âœ… ì—°ê²° í’€ë§ ì„¤ì • (ì„±ëŠ¥ í–¥ìƒ)
2. âœ… íƒ€ì„ì•„ì›ƒ ì„¤ì • (ì•ˆì •ì„±)
3. âœ… ì—°ê²° ì´ë²¤íŠ¸ í•¸ë“¤ë§ (ëª¨ë‹ˆí„°ë§)
4. âœ… exports ì„¤ì • (ëª¨ë“ˆ ì¬ì‚¬ìš©)

---

## Repository íŒ¨í„´ êµ¬í˜„

í”„ë¡œì íŠ¸ì˜ Repository íŒ¨í„´ì„ MongoDBì—ë„ ì ìš©í•©ë‹ˆë‹¤.

### Messages Repository

**src/modules/messages/repositories/messages.repository.ts**:
```typescript
import { Injectable } from '@nestjs/common';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { Message, MessageDocument } from '@/database/mongodb/schemas/message.schema';

export interface CreateMessageDto {
  conversationId: string;
  senderId: number;
  receiverId: number;
  message: string;
  messageType?: 'text' | 'image' | 'system';
}

export interface FindMessagesOptions {
  cursor?: string; // Cursor Paginationìš©
  limit?: number;
}

@Injectable()
export class MessagesRepository {
  constructor(
    @InjectModel(Message.name) private messageModel: Model<MessageDocument>,
  ) {}

  /**
   * ë©”ì‹œì§€ ìƒì„±
   */
  async create(data: CreateMessageDto): Promise<MessageDocument> {
    return this.messageModel.create(data);
  }

  /**
   * ëŒ€í™”ë°©ë³„ ë©”ì‹œì§€ ì¡°íšŒ (Cursor Pagination)
   */
  async findByConversation(
    conversationId: string,
    options: FindMessagesOptions = {},
  ): Promise<{ messages: MessageDocument[]; nextCursor?: string }> {
    const { cursor, limit = 50 } = options;

    // Cursor ê¸°ë°˜ ì¿¼ë¦¬
    const query: any = { conversationId };
    if (cursor) {
      query._id = { $lt: cursor }; // ì´ì „ ë©”ì‹œì§€ë“¤
    }

    const messages = await this.messageModel
      .find(query)
      .sort({ createdAt: -1 }) // ìµœì‹ ìˆœ
      .limit(limit + 1) // +1ë¡œ ë‹¤ìŒ í˜ì´ì§€ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      .exec();

    const hasNext = messages.length > limit;
    const items = hasNext ? messages.slice(0, limit) : messages;
    const nextCursor = hasNext
      ? items[items.length - 1]._id.toString()
      : undefined;

    return { messages: items, nextCursor };
  }

  /**
   * ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
   */
  async markAsRead(messageId: string): Promise<MessageDocument | null> {
    return this.messageModel
      .findByIdAndUpdate(
        messageId,
        { readAt: new Date() },
        { new: true },
      )
      .exec();
  }

  /**
   * ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì¡°íšŒ
   */
  async countUnread(receiverId: number): Promise<number> {
    return this.messageModel
      .countDocuments({
        receiverId,
        readAt: null,
      })
      .exec();
  }

  /**
   * ë©”ì‹œì§€ ì‚­ì œ
   */
  async delete(messageId: string): Promise<MessageDocument | null> {
    return this.messageModel.findByIdAndDelete(messageId).exec();
  }
}
```

### ChatRooms Repository (ì‹ ê·œ ì¶”ê°€)

**src/modules/messages/repositories/chat-rooms.repository.ts**:****
```typescript
import { Injectable } from '@nestjs/common';
import { InjectModel } from '@nestjs/mongoose';
import { Model, Types } from 'mongoose';
import { ChatRoom, ChatRoomDocument } from '@/database/mongodb/schemas/chat-room.schema';

@Injectable()
export class ChatRoomsRepository {
  constructor(
    @InjectModel(ChatRoom.name) private chatRoomModel: Model<ChatRoomDocument>,
  ) {}

  /**
   * ì±„íŒ…ë°© ìƒì„± ë˜ëŠ” ê¸°ì¡´ ë°© ì¡°íšŒ (Upsert-like logic)
   * ìƒí’ˆë³„/ì°¸ì—¬ìë³„ ìœ ë‹ˆí¬í•œ ë°©ì„ ìƒì„±í•¨
   */
  async findOrCreate(user1Id: number, user2Id: number, productId: number): Promise<ChatRoomDocument> {
    // ìƒí’ˆ ID + ë‘ ì‚¬ìš©ìê°€ ëª¨ë‘ í¬í•¨ëœ ë°© ì°¾ê¸°
    const existingRoom = await this.chatRoomModel.findOne({
      productId,
      'participants.userId': { $all: [user1Id, user2Id] },
    });

    if (existingRoom) {
      // ë‘˜ ë‹¤ ì°¸ì—¬ ì¤‘ì´ë©´ ë°”ë¡œ ë°˜í™˜
      const isUser1Active = existingRoom.participants.find(p => p.userId === user1Id && !p.leftAt);
      const isUser2Active = existingRoom.participants.find(p => p.userId === user2Id && !p.leftAt);

      if (isUser1Active && isUser2Active) {
        return existingRoom;
      }

      // í•œ ëª…ì´ë¼ë„ ë‚˜ê°”ë‹¤ë©´ -> ë‹¤ì‹œ ì°¸ì—¬ ì²˜ë¦¬ (leftAt: nullë¡œ ì—…ë°ì´íŠ¸)
      // ì‹¤ì œë¡œëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ë”°ë¼ "ìƒˆ ë°© ìƒì„±" vs "ê¸°ì¡´ ë°© ë¶€í™œ" ì •ì±… ê²°ì • í•„ìš”
      // ì—¬ê¸°ì„œëŠ” "ê¸°ì¡´ ë°© ë¶€í™œ"ë¡œ ì²˜ë¦¬
      await this.chatRoomModel.updateOne(
        { _id: existingRoom._id, 'participants.userId': user1Id },
        { $set: { 'participants.$.leftAt': null } }
      );
      await this.chatRoomModel.updateOne(
        { _id: existingRoom._id, 'participants.userId': user2Id },
        { $set: { 'participants.$.leftAt': null } }
      );
      
      return this.chatRoomModel.findById(existingRoom._id);
    }

    // ìƒˆ ë°© ìƒì„±
    return this.chatRoomModel.create({
      productId,
      participants: [
        { userId: user1Id, joinedAt: new Date() },
        { userId: user2Id, joinedAt: new Date() },
      ],
      lastMessageAt: new Date(),
    });
  }

  /**
   * ë‚´ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ
   */
  async findMyRooms(userId: number, limit = 20): Promise<ChatRoomDocument[]> {
    return this.chatRoomModel.find({
      participants: {
        $elemMatch: { userId, leftAt: null } // ë‚´ê°€ ì°¸ì—¬ ì¤‘ì´ê³  ë‚˜ê°€ì§€ ì•Šì€ ë°©
      }
    })
    .sort({ lastMessageAt: -1 }) // ìµœì‹  ë©”ì‹œì§€ ìˆœ
    .limit(limit)
    .exec();
  }

  /**
   * ì±„íŒ…ë°© ë‚˜ê°€ê¸°
   */
  async leaveRoom(roomId: string, userId: number): Promise<void> {
    await this.chatRoomModel.updateOne(
      { _id: new Types.ObjectId(roomId), 'participants.userId': userId },
      { 
        $set: { 'participants.$.leftAt': new Date() } 
      }
    ).exec();
  }

  /**
   * ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
   */
  async updateLastMessage(roomId: string, message: string, messageId: Types.ObjectId): Promise<void> {
    await this.chatRoomModel.findByIdAndUpdate(roomId, {
      lastMessage: message,
      lastMessageId: messageId,
      lastMessageAt: new Date()
    }).exec();
  }
}
```

**Cursor Pagination ì¥ì **:
- âœ… Offset Paginationë³´ë‹¤ ì„±ëŠ¥ ìš°ìˆ˜ (ëŒ€ìš©ëŸ‰ ë°ì´í„°)
- âœ… ì‹¤ì‹œê°„ ë°ì´í„° ì¶”ê°€ì—ë„ ì •í™•í•œ í˜ì´ì§•
- âœ… ì¸ë±ìŠ¤ í™œìš© ìµœì í™”

---

## Messages ëª¨ë“ˆ êµ¬í˜„ ì˜ˆì‹œ

### Service êµ¬í˜„

```typescript
import { Injectable } from '@nestjs/common';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { Message } from '@/database/mongodb/schemas/message.schema';

@Injectable()
export class MessagesService {
  constructor(
    @InjectModel(Message.name) private messageModel: Model<Message>,
    private chatRoomsRepository: ChatRoomsRepository, // ì£¼ì… í•„ìš”
  ) {}

  async sendMessage(senderId: number, receiverId: number, content: string, productId: number) {
    // 1. ì±„íŒ…ë°© í™•ë³´ (ìƒì„± ë˜ëŠ” ì¡°íšŒ) - ìƒí’ˆ ID ê¸°ì¤€
    const room = await this.chatRoomsRepository.findOrCreate(senderId, receiverId, productId);
    const roomId = room._id.toString();

    // 2. ë©”ì‹œì§€ ì €ì¥
    const newMessage = new this.messageModel({
      conversationId: roomId, // ì´ì œ ObjectId ì‚¬ìš©
      senderId,
      receiverId,
      message: content,
      messageType: 'text',
    });
    const savedMessage = await newMessage.save();

    // 3. ì±„íŒ…ë°© ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë“±)
    await this.chatRoomsRepository.updateLastMessage(roomId, content, savedMessage._id);

    return savedMessage;
  }

  async getMyChatRooms(userId: number) {
    return this.chatRoomsRepository.findMyRooms(userId);
  }

  async leaveChatRoom(userId: number, roomId: string) {
    return this.chatRoomsRepository.leaveRoom(roomId, userId);
  }

  async getMessages(roomId: string) { // ì¸ì ë³€ê²½: sender/receiver -> roomId
    return this.messageModel
      .find({ conversationId: roomId })
      .sort({ createdAt: -1 })
      .limit(50)
      .exec();
  }
}
```

**ì£¼ìš” ë³€ê²½ ì‚¬í•­**:
1. `ChatRoom` ê°œë… ë„ì…: ë‹¨ìˆœ ID ì¡°í•©ì´ ì•„ë‹Œ, ì‹¤ì œ DB ë¬¸ì„œë¡œ ì±„íŒ…ë°© ê´€ë¦¬
2. `findOrCreate`: ë°©ì´ ì—†ìœ¼ë©´ ë§Œë“¤ê³ , ë‚˜ê°”ë˜ ë°©ì´ë©´ ë‹¤ì‹œ ì°¸ì—¬ì‹œí‚´
3. `leaveRoom`: ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì§€ ì•Šê³  `leftAt` íƒ€ì„ìŠ¤íƒ¬í”„ë§Œ ì°ìŒ (Soft Delete ê°œë…)
4. `conversationId`: ë‹¨ìˆœ ë¬¸ìì—´ì´ ì•„ë‹Œ `ChatRoom`ì˜ `_id` ì°¸ì¡°ë¡œ ë³€ê²½ ê¶Œì¥
```

---

## í…ŒìŠ¤íŠ¸ ì „ëµ

### E2E í…ŒìŠ¤íŠ¸ (í”„ë¡œì íŠ¸ íŒ¨í„´ ì ìš©)

í”„ë¡œì íŠ¸ì˜ Given-When-Then íŒ¨í„´ê³¼ TestDataFactoryë¥¼ í™œìš©í•©ë‹ˆë‹¤.

**íŒ¨í‚¤ì§€ ì„¤ì¹˜**:
```bash
npm install -D mongodb-memory-server
```

**E2E í…ŒìŠ¤íŠ¸ ì„¤ì •**:
```typescript
// src/modules/messages/messages.e2e.spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { MongooseModule } from '@nestjs/mongoose';
import { MongoMemoryServer } from 'mongodb-memory-server';
import { AppModule } from '@/app.module';
import { TestDataFactory } from '@/test/fixtures/test-data.factory';

describe('Messages API (e2e)', () => {
  let app: INestApplication;
  let mongod: MongoMemoryServer;
  let testDataFactory: TestDataFactory;

  beforeAll(async () => {
    // ì¸ë©”ëª¨ë¦¬ MongoDB ì‹œì‘
    mongod = await MongoMemoryServer.create();
    const mongoUri = mongod.getUri();

    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    })
      .overrideProvider('MONGODB_URI')
      .useValue(mongoUri)
      .compile();

    app = moduleFixture.createNestApplication();
    await app.init();

    testDataFactory = new TestDataFactory(/* ... */);
  });

  afterAll(async () => {
    await mongod.stop();
    await app.close();
  });

  afterEach(async () => {
    // ê° í…ŒìŠ¤íŠ¸ í›„ MongoDB ë°ì´í„° ì •ë¦¬
    const connection = app.get('DatabaseConnection');
    const collections = await connection.db.collections();
    for (const collection of collections) {
      await collection.deleteMany({});
    }
  });

  describe('POST /api/v1/messages - ë©”ì‹œì§€ ì „ì†¡', () => {
    let buyer: any, seller: any;

    beforeEach(async () => {
      // ğŸ“ Given: êµ¬ë§¤ìì™€ íŒë§¤ì ìƒì„±
      const { seller: testSeller, buyer: testBuyer } =
        await testDataFactory.createSellerAndBuyer();
      seller = testSeller;
      buyer = testBuyer;
    });

    it('êµ¬ë§¤ìê°€ íŒë§¤ìì—ê²Œ ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ', async () => {
      // ğŸ§ª When: ë©”ì‹œì§€ ì „ì†¡ API í˜¸ì¶œ
      const res = await request(app.getHttpServer())
        .post('/api/v1/messages')
        .set('Authorization', `Bearer ${buyer.token}`)
        .send({
          receiverId: seller.id,
          content: 'ì•ˆë…•í•˜ì„¸ìš”',
          messageType: 'text',
        })
        .expect(201);

      // âœ… Then: ì‘ë‹µ ê²€ì¦
      const body = res.body;
      expect(body.success).toBe(true);
      expect(body.data.senderId).toBe(buyer.id);
      expect(body.data.receiverId).toBe(seller.id);
      expect(body.data.content).toBe('ì•ˆë…•í•˜ì„¸ìš”');
    });

    it('ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨', async () => {
      // ğŸ§ª When: í† í° ì—†ì´ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„
      const response = await request(app.getHttpServer())
        .post('/api/v1/messages')
        .send({
          receiverId: seller.id,
          content: 'ì•ˆë…•í•˜ì„¸ìš”',
        })
        .expect(401);

      expect(response.body.message).toContain('ì¸ì¦');
    });
  });

  describe('GET /api/v1/messages - ë©”ì‹œì§€ ì¡°íšŒ', () => {
    it('ëŒ€í™”ë°© ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ ì„±ê³µ', async () => {
      // ğŸ“ Given: ë©”ì‹œì§€ ìƒì„±
      // ... í…ŒìŠ¤íŠ¸ ë¡œì§
    });
  });
});
```

**TestDataFactory í™•ì¥ ì˜ˆì‹œ**:
```typescript
// src/test/fixtures/test-message-data.factory.ts
export class TestMessageDataFactory {
  constructor(private messageModel: Model<MessageDocument>) {}

  async createConversation(senderId: number, receiverId: number) {
    const conversationId = [senderId, receiverId].sort().join('-');

    const messages = await Promise.all([
      this.messageModel.create({
        conversationId,
        senderId,
        receiverId,
        message: 'ì•ˆë…•í•˜ì„¸ìš”',
        messageType: 'text',
      }),
      this.messageModel.create({
        conversationId,
        senderId: receiverId,
        receiverId: senderId,
        message: 'ë„¤ ì•ˆë…•í•˜ì„¸ìš”',
        messageType: 'text',
      }),
    ]);

    return { conversationId, messages };
  }
}
```

**beforeAll vs beforeEach ì›ì¹™ ì ìš©**:
- âœ… `beforeAll`: ì½ê¸° ì „ìš© í…ŒìŠ¤íŠ¸ (GET ìš”ì²­)
- âœ… `beforeEach`: ë°ì´í„° ë³€ê²½ í…ŒìŠ¤íŠ¸ (POST, PATCH, DELETE)

---

## ì„±ëŠ¥ ìµœì í™”

### 1. Lean ì¿¼ë¦¬ (Plain Object ë°˜í™˜)

```typescript
// âŒ ëŠë¦¼: Mongoose Document ë°˜í™˜ (ë©”ì„œë“œ, getter í¬í•¨)
const messages = await this.messageModel.find({ conversationId }).exec();

// âœ… ë¹ ë¦„: Plain JavaScript Object ë°˜í™˜
const messages = await this.messageModel
  .find({ conversationId })
  .lean()
  .exec();
```

**ì‚¬ìš© ì‹œê¸°**:
- ì½ê¸° ì „ìš© ë°ì´í„°
- API ì‘ë‹µìš© ë°ì´í„°
- ëŒ€ëŸ‰ ë°ì´í„° ì¡°íšŒ

**ì‚¬ìš©í•˜ì§€ ë§ì•„ì•¼ í•  ë•Œ**:
- Document ë©”ì„œë“œ í•„ìš” (save, validate ë“±)
- Virtual í•„ë“œ í•„ìš”
- Middleware ì‹¤í–‰ í•„ìš”

### 2. í”„ë¡œì ì…˜ (í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ)

```typescript
// âŒ ë¹„íš¨ìœ¨: ëª¨ë“  í•„ë“œ ì¡°íšŒ
const messages = await this.messageModel.find({ conversationId });

// âœ… íš¨ìœ¨: í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
const messages = await this.messageModel
  .find({ conversationId })
  .select('senderId receiverId message createdAt')
  .lean()
  .exec();
```

### 3. ì¸ë±ìŠ¤ í™œìš© í™•ì¸

```typescript
// ì¿¼ë¦¬ ì„±ëŠ¥ ë¶„ì„
const explain = await this.messageModel
  .find({ conversationId: 'test-123' })
  .explain('executionStats');

console.log(explain.executionStats);
// totalDocsExamined: ê²€ì‚¬í•œ ë¬¸ì„œ ìˆ˜
// nReturned: ë°˜í™˜í•œ ë¬¸ì„œ ìˆ˜
// executionTimeMillis: ì‹¤í–‰ ì‹œê°„
```

**ìµœì í™”ëœ ì¿¼ë¦¬ íŠ¹ì§•**:
- `totalDocsExamined` â‰ˆ `nReturned` (ì¸ë±ìŠ¤ í™œìš©)
- `executionTimeMillis` < 10ms (ë¹ ë¥¸ ì‘ë‹µ)

### 4. Aggregation Pipeline (ë³µì¡í•œ ì¿¼ë¦¬)

```typescript
// ëŒ€í™”ë°©ë³„ ë©”ì‹œì§€ í†µê³„
async getConversationStats(conversationId: string) {
  return this.messageModel.aggregate([
    { $match: { conversationId } },
    {
      $group: {
        _id: '$messageType',
        count: { $sum: 1 },
        unreadCount: {
          $sum: { $cond: [{ $eq: ['$readAt', null] }, 1, 0] },
        },
      },
    },
  ]);
}
```

### 5. ë²Œí¬ ì‘ì—… (Bulk Operations)

```typescript
// âŒ ë¹„íš¨ìœ¨: ë°˜ë³µë¬¸ìœ¼ë¡œ ê°œë³„ ì—…ë°ì´íŠ¸
for (const message of messages) {
  await this.messageModel.updateOne(
    { _id: message._id },
    { readAt: new Date() }
  );
}

// âœ… íš¨ìœ¨: ë²Œí¬ ì—…ë°ì´íŠ¸
await this.messageModel.updateMany(
  { conversationId, receiverId: userId, readAt: null },
  { readAt: new Date() }
);
```

---

## í¬ë¡œìŠ¤ DB íŠ¸ëœì­ì…˜ ì²˜ë¦¬

### âš ï¸ ë¬¸ì œì 

MongoDBì™€ PostgreSQLì€ **ì„œë¡œ ë‹¤ë¥¸ ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œ**ì´ë¯€ë¡œ,
**ë¶„ì‚° íŠ¸ëœì­ì…˜(Two-Phase Commit)ì´ ë¶ˆê°€ëŠ¥**í•©ë‹ˆë‹¤.

```typescript
// âŒ ë¶ˆê°€ëŠ¥: í¬ë¡œìŠ¤ DB íŠ¸ëœì­ì…˜
await prisma.$transaction(async (tx) => {
  const order = await tx.order.create({...}); // PostgreSQL
  const message = await mongoModel.create({...}); // MongoDB
  // ë‘˜ ì¤‘ í•˜ë‚˜ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ë¶ˆê°€ëŠ¥!
});
```

### âœ… í•´ê²° ë°©ë²• 1: Saga íŒ¨í„´ (ë³´ìƒ íŠ¸ëœì­ì…˜)

```typescript
// src/modules/orders/orders.service.ts
async createOrderWithNotification(userId: number, orderData: CreateOrderDto) {
  let createdOrder: Order | null = null;
  let createdMessage: MessageDocument | null = null;

  try {
    // 1ë‹¨ê³„: PostgreSQL - ì£¼ë¬¸ ìƒì„±
    createdOrder = await this.ordersRepository.create(orderData);

    // 2ë‹¨ê³„: MongoDB - ì‹œìŠ¤í…œ ë©”ì‹œì§€ ìƒì„±
    createdMessage = await this.messagesRepository.create({
      conversationId: `order-${createdOrder.id}`,
      senderId: 0, // ì‹œìŠ¤í…œ
      receiverId: userId,
      message: `ì£¼ë¬¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸: ${createdOrder.id}`,
      messageType: 'system',
    });

    return { order: createdOrder, message: createdMessage };
  } catch (error) {
    // âš ï¸ ë³´ìƒ íŠ¸ëœì­ì…˜: ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ ì‚­ì œ
    if (createdOrder) {
      await this.ordersRepository.delete(createdOrder.id);
      console.log(`âœ… ë³´ìƒ: ì£¼ë¬¸ ${createdOrder.id} ì‚­ì œ ì™„ë£Œ`);
    }
    if (createdMessage) {
      await this.messagesRepository.delete(createdMessage._id.toString());
      console.log(`âœ… ë³´ìƒ: ë©”ì‹œì§€ ì‚­ì œ ì™„ë£Œ`);
    }
    throw error;
  }
}
```

**ì¥ì **:
- âœ… êµ¬í˜„ì´ ëª…í™•í•˜ê³  ì§ê´€ì 
- âœ… ì—ëŸ¬ ì¶”ì  ìš©ì´

**ë‹¨ì **:
- âŒ ë³´ìƒ ë¡œì§ì´ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìŒ
- âŒ ë³´ìƒ ì‘ì—… ìì²´ê°€ ì‹¤íŒ¨í•  ê°€ëŠ¥ì„±

### âœ… í•´ê²° ë°©ë²• 2: ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ (ê¶Œì¥)

```typescript
// src/modules/orders/orders.service.ts
import { EventEmitter2 } from '@nestjs/event-emitter';

@Injectable()
export class OrdersService {
  constructor(
    private ordersRepository: OrdersRepository,
    private eventEmitter: EventEmitter2,
  ) {}

  async createOrder(userId: number, orderData: CreateOrderDto) {
    // PostgreSQL: ì£¼ë¬¸ ìƒì„±
    const order = await this.ordersRepository.create(orderData);

    // ì´ë²¤íŠ¸ ë°œí–‰ (ë¹„ë™ê¸°)
    this.eventEmitter.emit('order.created', {
      orderId: order.id,
      userId,
      sellerId: order.sellerId,
    });

    return order;
  }
}
```

```typescript
// src/modules/messages/listeners/order-created.listener.ts
import { Injectable } from '@nestjs/common';
import { OnEvent } from '@nestjs/event-emitter';

@Injectable()
export class OrderCreatedListener {
  constructor(private messagesRepository: MessagesRepository) {}

  @OnEvent('order.created')
  async handleOrderCreated(payload: { orderId: string; userId: number; sellerId: number }) {
    try {
      // MongoDB: ì‹œìŠ¤í…œ ë©”ì‹œì§€ ìƒì„±
      await this.messagesRepository.create({
        conversationId: `order-${payload.orderId}`,
        senderId: 0, // ì‹œìŠ¤í…œ
        receiverId: payload.userId,
        message: `ì£¼ë¬¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸: ${payload.orderId}`,
        messageType: 'system',
      });
      console.log(`âœ… ì£¼ë¬¸ ${payload.orderId} ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„± ì™„ë£Œ`);
    } catch (error) {
      console.error(`âŒ ì£¼ë¬¸ ${payload.orderId} ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„± ì‹¤íŒ¨:`, error);
      // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ ë˜ëŠ” Dead Letter Queue
    }
  }
}
```

**ì¥ì **:
- âœ… ëŠìŠ¨í•œ ê²°í•© (Loose Coupling)
- âœ… í™•ì¥ì„± ìš°ìˆ˜
- âœ… ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì„±ëŠ¥ í–¥ìƒ

**ë‹¨ì **:
- âŒ ì´ë²¤íŠ¸ ìœ ì‹¤ ê°€ëŠ¥ì„± (RabbitMQ ë“±ìœ¼ë¡œ ë³´ì™„)
- âŒ ìµœì¢… ì¼ê´€ì„± (Eventual Consistency)

### âœ… í•´ê²° ë°©ë²• 3: ì„ í–‰ ì»¤ë°‹ + ë³´ìƒ

```typescript
async createOrderWithMessage(userId: number, orderData: CreateOrderDto) {
  // 1ë‹¨ê³„: ì¤‘ìš”í•œ ì‘ì—… ë¨¼ì € (PostgreSQL)
  const order = await this.ordersRepository.create(orderData);

  // 2ë‹¨ê³„: ë¶€ê°€ ì‘ì—… (MongoDB) - ì‹¤íŒ¨í•´ë„ ì£¼ë¬¸ì€ ìœ ì§€
  try {
    await this.messagesRepository.create({
      conversationId: `order-${order.id}`,
      senderId: 0,
      receiverId: userId,
      message: `ì£¼ë¬¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      messageType: 'system',
    });
  } catch (error) {
    // ë©”ì‹œì§€ ìƒì„± ì‹¤íŒ¨ëŠ” ë¡œê¹…ë§Œ (ì£¼ë¬¸ì€ ìœ ì§€)
    console.error('ë©”ì‹œì§€ ìƒì„± ì‹¤íŒ¨:', error);
    // ì„ íƒ: ë‚˜ì¤‘ì— ì¬ì‹œë„ íì— ì¶”ê°€
  }

  return order;
}
```

**ì–¸ì œ ì‚¬ìš©**:
- ì£¼ ì‘ì—…(Order)ì´ ë¶€ê°€ ì‘ì—…(Message)ë³´ë‹¤ ì¤‘ìš”í•  ë•Œ
- ë¶€ê°€ ì‘ì—… ì‹¤íŒ¨ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ì— í° ì˜í–¥ì„ ì£¼ì§€ ì•Šì„ ë•Œ

---

## ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ë™ê¸°í™”

### PostgreSQL â†’ MongoDB ë°ì´í„° ë™ê¸°í™”

```typescript
// scripts/sync-products-to-mongodb.ts
import { PrismaClient } from '@prisma/client';
import { connect, connection, Model } from 'mongoose';
import { ProductDetail } from '../src/database/mongodb/schemas/product-detail.schema';

async function syncProductsToMongoDB() {
  const prisma = new PrismaClient();
  await connect(process.env.MONGODB_URI);

  try {
    const products = await prisma.product.findMany({
      select: {
        id: true,
        description: true,
        images: true,
      },
    });

    console.log(`ğŸ“¦ ë™ê¸°í™”í•  ìƒí’ˆ: ${products.length}ê°œ`);

    let successCount = 0;
    let errorCount = 0;

    for (const product of products) {
      try {
        await ProductDetailModel.findOneAndUpdate(
          { productId: product.id },
          {
            productId: product.id,
            description: product.description || '',
            images: product.images || [],
            specifications: {},
          },
          { upsert: true, new: true }
        );
        successCount++;

        if (successCount % 100 === 0) {
          console.log(`ì§„í–‰ ì¤‘: ${successCount}/${products.length}`);
        }
      } catch (error) {
        console.error(`âŒ ìƒí’ˆ ${product.id} ë™ê¸°í™” ì‹¤íŒ¨:`, error.message);
        errorCount++;
      }
    }

    console.log(`âœ… ë™ê¸°í™” ì™„ë£Œ: ì„±ê³µ ${successCount}, ì‹¤íŒ¨ ${errorCount}`);
  } finally {
    await prisma.$disconnect();
    await connection.close();
  }
}

syncProductsToMongoDB()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

**ì‹¤í–‰**:
```bash
# ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
ts-node scripts/sync-products-to-mongodb.ts
```

### ì‹¤ì‹œê°„ ë™ê¸°í™” (ì´ë²¤íŠ¸ ê¸°ë°˜)

```typescript
// src/modules/products/products.service.ts
@Injectable()
export class ProductsService {
  constructor(
    private productsRepository: ProductsRepository,
    private eventEmitter: EventEmitter2,
  ) {}

  async create(userId: string, dto: CreateProductDto) {
    // PostgreSQLì— ì €ì¥
    const product = await this.productsRepository.create({
      userId,
      ...dto,
    });

    // MongoDB ë™ê¸°í™” ì´ë²¤íŠ¸ ë°œí–‰
    this.eventEmitter.emit('product.created', {
      productId: product.id,
      description: dto.description,
      images: dto.images,
    });

    return product;
  }
}
```

```typescript
// src/database/mongodb/listeners/product-sync.listener.ts
@Injectable()
export class ProductSyncListener {
  constructor(
    @InjectModel(ProductDetail.name)
    private productDetailModel: Model<ProductDetailDocument>,
  ) {}

  @OnEvent('product.created')
  async handleProductCreated(payload: any) {
    await this.productDetailModel.create({
      productId: payload.productId,
      description: payload.description,
      images: payload.images || [],
      specifications: {},
    });
  }

  @OnEvent('product.updated')
  async handleProductUpdated(payload: any) {
    await this.productDetailModel.findOneAndUpdate(
      { productId: payload.productId },
      {
        description: payload.description,
        images: payload.images,
      }
    );
  }
}
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ê³µì‹ ë¬¸ì„œ
- [NestJS Mongoose](https://docs.nestjs.com/techniques/mongodb)
- [Mongoose Documentation](https://mongoosejs.com/docs/guide.html)
- [MongoDB Node.js Driver](https://www.mongodb.com/docs/drivers/node/current/)

### ì„±ëŠ¥ ìµœì í™”
- [Mongoose Performance](https://mongoosejs.com/docs/tutorials/performance.html)
- [MongoDB Indexing Strategies](https://www.mongodb.com/docs/manual/indexes/)

### ëª¨ë²” ì‚¬ë¡€
- [MongoDB Schema Design Best Practices](https://www.mongodb.com/developer/products/mongodb/mongodb-schema-design-best-practices/)

---

**ë‹¤ìŒ ë‹¨ê³„**: [Messages ëª¨ë“ˆ êµ¬í˜„ ì‹œì‘](./ë‹¤ìŒ_ì‘ì—…_ê³„íš.md#1-messages-ëª¨ë“ˆ-êµ¬í˜„-ìµœìš°ì„ )

**ê´€ë ¨ ë¬¸ì„œ**:
- [ë‹¤ìŒ ì‘ì—… ê³„íš](./ë‹¤ìŒ_ì‘ì—…_ê³„íš.md)
- [ê°œë°œ ê³„íšì„œ](./ê°œë°œê³„íšì„œ_2025_10_24_ì—…ë°ì´íŠ¸.md)
- [RabbitMQ ì´ë²¤íŠ¸ ê°€ì´ë“œ](./rabbitmq-events-guide.md)

---

## ğŸ“š [ë¶€ë¡] í„°ë¯¸ë„ ì¹˜íŠ¸ì‹œíŠ¸

í„°ë¯¸ë„ì—ì„œ ì§ì ‘ DBì— ì ‘ì†í•˜ì—¬ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  ì‹¶ì„ ë•Œ ìœ ìš©í•œ ëª…ë ¹ì–´ ëª¨ìŒì…ë‹ˆë‹¤.

### 1. ì ‘ì†í•˜ê¸°

**ë¡œì»¬ ì ‘ì†**:
```bash
# ê¸°ë³¸ ì ‘ì† (test DB)
mongosh

# íŠ¹ì • DB ì ‘ì†
mongosh "mongodb://localhost:27017/secondhand"
```

**Docker ì»¨í…Œì´ë„ˆ ì ‘ì†**:
```bash
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ shell ì‹¤í–‰
docker exec -it secondhand-mongodb mongosh
```

### 2. í•„ìˆ˜ ëª…ë ¹ì–´

| ë™ì‘ | ëª…ë ¹ì–´ | ì˜ˆì‹œ |
|------|--------|------|
| **DB ëª©ë¡** | `show dbs` | |
| **DB ì„ íƒ** | `use <db_name>` | `use secondhand` |
| **ì»¬ë ‰ì…˜ ëª©ë¡** | `show collections` | |
| **í™”ë©´ ì§€ìš°ê¸°** | `cls` | |
| **ì¢…ë£Œ** | `exit` | |

### 3. ë°ì´í„° ì¡°íšŒ (CRUD)

**ì „ì²´ ì¡°íšŒ**:
```javascript
// ëª¨ë“  ë©”ì‹œì§€ ì¡°íšŒ
db.messages.find()

// ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥ (.pretty()ëŠ” ìµœì‹  ë²„ì „ì—ì„œ ìë™ ì ìš©ë¨)
db.messages.find()
```

**ì¡°ê±´ ì¡°íšŒ**:
```javascript
// íŠ¹ì • ëŒ€í™”ë°©ì˜ ë©”ì‹œì§€ ì°¾ê¸°
db.messages.find({ conversationId: "1-2" })

// ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì°¾ê¸°
db.messages.find({ readAt: null })
```

**ê°œìˆ˜ í™•ì¸**:
```javascript
db.messages.countDocuments()
```

**ì‚­ì œ**:
```javascript
// íŠ¹ì • ë°ì´í„° ì‚­ì œ
db.messages.deleteOne({ _id: ObjectId("...") })

// ì „ì²´ ì‚­ì œ (ì£¼ì˜!)
db.messages.deleteMany({})
```

### 4. ì¸ë±ìŠ¤ í™•ì¸

```javascript
// ì¸ë±ìŠ¤ ëª©ë¡ ì¡°íšŒ
db.messages.getIndexes()

// ì¿¼ë¦¬ ì‹¤í–‰ ê³„íš í™•ì¸ (ì¸ë±ìŠ¤ íƒ€ëŠ”ì§€ í™•ì¸)
db.messages.find({ conversationId: "1-2" }).explain("executionStats")
```

---

**ë¬¸ì„œ ë²„ì „**: v1.2 (ë¶€ë¡ ì¶”ê°€)
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-12-04
**ê²€í† ì**: Claude Code
**ë³€ê²½ ì´ë ¥**:
- v1.2 (2025-12-04): í„°ë¯¸ë„ ì ‘ì† ê°€ì´ë“œ ë° ì¹˜íŠ¸ì‹œíŠ¸ ì¶”ê°€
- v1.1 (2025-12-03): í”„ë¡œì íŠ¸ êµ¬ì¡° ë°˜ì˜, ì„±ëŠ¥ ìµœì í™”, í¬ë¡œìŠ¤ DB íŠ¸ëœì­ì…˜, í…ŒìŠ¤íŠ¸ íŒ¨í„´ ê°œì„ 
- v1.0 (2025-12-03): ì´ˆì•ˆ ì‘ì„±
