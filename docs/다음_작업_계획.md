# 다음 작업 계획

**작성일**: 2025-12-03 (업데이트)
**현재 상태**: Phase 4 진행 중 - Reviews 모듈 완료
**다음 Phase**: Phase 4 계속 - Messages/Notifications 구현

---

## 📊 현재 진행 상황

### ✅ 최근 완료 작업 (2025-12-03)

#### Reviews 모듈 구현 완료 ⭐ NEW
**완료일**: 2025-12-03

**주요 구현 사항**:
- ✅ Reviews 엔티티 설계 및 마이그레이션 완료
- ✅ Repository 패턴 구현 (신뢰도 점수 계산 로직 포함)
- ✅ Service 계층 비즈니스 로직 구현
- ✅ Controller 8개 API 엔드포인트 구현
- ✅ E2E 테스트 28개 작성 및 통과
- ✅ TestReviewDataFactory 테스트 헬퍼 구현
- ✅ DTO 구조 개선 (PaginationDto 확장)

**API 엔드포인트** (8개):
```typescript
POST   /api/v1/reviews              // 리뷰 작성
GET    /api/v1/reviews/user         // 사용자별 리뷰 목록 (쿼리 필터)
GET    /api/v1/reviews/received     // 내가 받은 리뷰
GET    /api/v1/reviews/given        // 내가 작성한 리뷰
GET    /api/v1/reviews/order/:id    // 주문별 리뷰 조회
GET    /api/v1/reviews/:id          // 리뷰 상세 조회
GET    /api/v1/reviews/trust/:id    // 신뢰도 점수 조회
PATCH  /api/v1/reviews/:id          // 리뷰 수정
DELETE /api/v1/reviews/:id          // 리뷰 삭제
```

**테스트 커버리지**:
- ✅ 리뷰 작성 성공/실패 케이스 (6개)
- ✅ 리뷰 수정 권한 검증 (2개)
- ✅ 리뷰 삭제 및 신뢰도 재계산 (4개)
- ✅ 리뷰 조회 (사용자별, 받은/작성한, 상세) (11개)
- ✅ 주문별 리뷰 조회 (2개)
- ✅ 신뢰도 점수 조회 (2개)
- ✅ 페이지네이션 및 필터링 (1개)

**테스트 품질 개선**:
- ✅ `beforeEach` vs `beforeAll` 원칙 적용 (읽기 vs 쓰기)
- ✅ Given-When-Then 패턴으로 가독성 향상
- ✅ 도메인별 TestFactory 분리 패턴 확립

---

### ✅ 이전 완료 작업 (2025-12-02)

#### AuthModule 리팩토링 및 테스트 강화
**커밋**: `3474375`

**주요 변경사항**:
- `src/common/auth/` → `src/modules/auth/` 중앙화
- 모든 모듈의 중복 인증 설정 제거
- JWT Guard 전용 E2E 테스트 추가 (15개)

**영향받은 모듈**:
- users, categories, products, orders, reviews, notifications, messages

**테스트 결과**:
- 새로운 테스트: 15개 (모두 통과)
- 실행 시간: 1.5초
- 커버리지: @Public() 데코레이터, 토큰 검증, 에러 핸들링

### 📈 업데이트된 테스트 현황

| 테스트 분류 | 개수 | 상태 |
|-----------|------|------|
| Users E2E | 13 | ✅ |
| Products E2E | 21 | ✅ |
| Categories E2E | 11 | ✅ |
| Orders E2E | 17 | ✅ |
| **Reviews E2E** | **28** | **✅ NEW** |
| Favorites E2E | 0 | 📝 |
| Auth Guard E2E | 15 | ✅ |
| JWT 단위 테스트 | 33 | ✅ |
| **총 테스트** | **138** | **✅** |

**증가**: 110 → 138개 (+28개, Reviews 모듈)

### 🏗️ 완성된 모듈 현황

| 모듈 | 상태 | API | E2E | 특이사항 |
|------|------|-----|-----|---------|
| **Auth** | ✅ | - | 15 | 중앙화 완료, Guard 테스트 |
| **Users** | ✅ | 6 | 13 | JWT 인증, RBAC |
| **Products** | ✅ | 8 | 21 | 검색, 필터링, 상태 관리 |
| **Categories** | ✅ | 5 | 11 | 계층형 구조 |
| **Orders** | ✅ | 8 | 17 | 상태 머신 패턴 |
| **Reviews** | ✅ | 8 | 28 | 신뢰도 점수 시스템, TestFactory 패턴 |
| **Favorites** | ✅ | 4 | 0 | E2E 테스트 필요 |
| Messages | 📝 | 0 | 0 | Phase 4 다음 목표 |
| Notifications | 📝 | 0 | 0 | Phase 4 예정 |

---

## 🎯 Phase 4: 확장 도메인 구현

### 1. ✅ Reviews 모듈 (완료)

**목표**: 거래 후 리뷰 및 평점 시스템 구축
**완료일**: 2025-12-03
**실제 기간**: 1일 (예상 5일 → 효율적 완료)
**비즈니스 가치**: ⭐⭐⭐⭐⭐ (신뢰도 향상 핵심)

#### ✅ 완료된 작업

**✅ 엔티티 설계 및 마이그레이션**
- Prisma 스키마 설계 완료
- `images` 필드 추가 (리뷰 이미지 URL 배열)
- 인덱스 최적화 (reviewerId, reviewedId)
- Cascade 삭제 정책 적용

**✅ API 구현 (8개 - 예상보다 1개 추가)**
```typescript
POST   /api/v1/reviews              // 리뷰 작성
GET    /api/v1/reviews/user         // 사용자별 리뷰 목록 (쿼리 필터)
GET    /api/v1/reviews/received     // 내가 받은 리뷰
GET    /api/v1/reviews/given        // 내가 작성한 리뷰
GET    /api/v1/reviews/order/:id    // 주문별 리뷰 조회
GET    /api/v1/reviews/:id          // 리뷰 상세 조회
GET    /api/v1/reviews/trust/:id    // 신뢰도 점수 조회 (추가)
PATCH  /api/v1/reviews/:id          // 리뷰 수정
DELETE /api/v1/reviews/:id          // 리뷰 삭제
```

**✅ 비즈니스 규칙 모두 구현**:
- ✅ CONFIRMED 상태 주문만 리뷰 작성 가능
- ✅ orderId unique constraint로 중복 방지
- ✅ 본인 리뷰만 수정/삭제 (403 Forbidden)
- ✅ 평점 1-5 범위 검증 (class-validator)
- ✅ 이미지 URL 배열 지원

**✅ 신뢰도 점수 시스템 구현**
```typescript
interface TrustScoreResponseDto {
  userId: string;
  trustScore: number;         // 0-100 점수
  averageRating: number;      // 소수점 2자리
  totalReviews: number;
  ratingDistribution: {       // 평점 분포
    1: number;
    2: number;
    3: number;
    4: number;
    5: number;
  };
}
```

계산 로직 완료:
- `trustScore = (averageRating / 5) * 100`
- 평점 분포 집계 (GROUP BY rating)
- 리뷰 삭제 시 자동 재계산

**✅ E2E 테스트 (28개 - 예상보다 13개 추가)**

테스트 분류:
```
리뷰 작성 (6개):
- ✅ 구매 확정 후 리뷰 작성 성공
- ✅ 중복 리뷰 작성 실패
- ✅ 완료되지 않은 주문 리뷰 작성 실패
- ✅ 평점 < 1 검증 실패
- ✅ 평점 > 5 검증 실패

리뷰 수정 (2개):
- ✅ 리뷰 작성자 수정 성공
- ✅ 다른 사용자 수정 시도 실패 (403)

리뷰 삭제 (4개):
- ✅ 다른 사용자 삭제 시도 실패 (403)
- ✅ 리뷰 작성자 삭제 성공
- ✅ 삭제된 리뷰 조회 실패 (404)
- ✅ 삭제 후 신뢰도 점수 재계산 검증

리뷰 조회 (16개):
- ✅ 사용자별 리뷰 목록 조회
- ✅ 최소 평점 필터링
- ✅ 페이지네이션 동작
- ✅ 내가 받은 리뷰 조회
- ✅ 리뷰 없는 사용자 빈 배열 반환
- ✅ 내가 작성한 리뷰 조회
- ✅ 리뷰 상세 조회
- ✅ 존재하지 않는 리뷰 조회 실패
- ✅ 주문별 리뷰 조회 성공
- ✅ 리뷰 없는 주문 null 반환
- ✅ 사용자 신뢰도 점수 조회
- ✅ 리뷰 없는 사용자 신뢰도 0
```

**✅ 테스트 품질 개선 사항**:
- `beforeEach` vs `beforeAll` 명확한 분리 (읽기 vs 쓰기)
- Given-When-Then 패턴 적용
- TestReviewDataFactory 헬퍼 클래스 구현
- 시나리오 기반 테스트 데이터 생성 메서드

#### 실제 산출물
- ✅ Reviews 모듈 완성 (Repository, Service, Controller)
- ✅ 8개 API 엔드포인트 (예상 7개 → 8개)
- ✅ E2E 테스트 28개 (예상 12-15개 → 28개, +13개 초과 달성)
- ✅ 신뢰도 점수 시스템 완성
- ✅ TestReviewDataFactory 패턴 확립
- ✅ **총 테스트 수: 110 → 138개 (+28개)**

---

### 2. Messages 모듈 (우선순위 2) 📝

**목표**: 구매자-판매자 1:1 채팅 시스템
**예상 기간**: 5일 (Week 12)
**비즈니스 가치**: ⭐⭐⭐⭐ (거래 편의성)

#### 기술 선택 고려사항

**데이터베이스 선택**:
- **MongoDB** (추천): 빠른 조회, 유연한 스키마, 채팅 히스토리 적합
- PostgreSQL: ACID 보장, 기존 스키마 통합

**실시간 통신 방식**:
- **HTTP 폴링** (추천): 간단한 구현, 인프라 부담 적음
- WebSocket (Socket.IO): 실시간성 우수, 복잡도 증가

#### 작업 계획

**Day 1: 스키마 설계**

MongoDB 스키마 (추천):
```typescript
// Conversation Collection
interface Conversation {
  _id: ObjectId;
  productId: string;      // 상품 ID
  buyerId: string;        // 구매자 ID
  sellerId: string;       // 판매자 ID
  lastMessageAt: Date;    // 마지막 메시지 시간
  unreadCount: {          // 읽지 않은 메시지 수
    [userId: string]: number;
  };
  createdAt: Date;
}

// Message Collection
interface Message {
  _id: ObjectId;
  conversationId: ObjectId;
  senderId: string;
  content: string;
  isRead: boolean;
  createdAt: Date;
}
```

**Day 2-3: API 구현**

엔드포인트 (예상 8개):
```typescript
POST   /api/v1/messages/conversations        // 채팅방 생성
GET    /api/v1/messages/conversations        // 채팅방 목록
GET    /api/v1/messages/conversations/:id    // 채팅방 상세 (메시지 히스토리)
POST   /api/v1/messages                      // 메시지 전송
PATCH  /api/v1/messages/:id/read             // 메시지 읽음 처리
DELETE /api/v1/messages/:id                  // 메시지 삭제
GET    /api/v1/messages/unread-count         // 읽지 않은 메시지 수
PATCH  /api/v1/messages/conversations/:id/read-all // 전체 읽음 처리
```

**Day 4: 폴링 시스템 (선택적)**

Long Polling 구현:
```typescript
GET /api/v1/messages/poll?conversationId=xxx&lastMessageId=yyy
```

**Day 5: E2E 테스트**

테스트 케이스 (예상 15-18개):
- 채팅방 생성/조회
- 메시지 송수신
- 읽음 처리
- 권한 검증 (당사자만 접근)

---

### 3. Notifications 모듈 (우선순위 3) 📝

**목표**: 통합 알림 시스템
**예상 기간**: 5일 (Week 13)
**비즈니스 가치**: ⭐⭐⭐⭐ (사용자 경험)

#### 작업 계획

**Day 1: 엔티티 설계**

```prisma
enum NotificationType {
  ORDER_STATUS_CHANGED
  NEW_MESSAGE
  REVIEW_RECEIVED
  PRODUCT_LIKED
  PRODUCT_SOLD
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  metadata  Json?            // 추가 정보 (주문ID, 메시지ID 등)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}
```

**Day 2-3: API 및 이벤트 통합**

엔드포인트 (예상 6개):
```typescript
GET    /api/v1/notifications           // 알림 목록
GET    /api/v1/notifications/unread    // 읽지 않은 알림
PATCH  /api/v1/notifications/:id/read  // 읽음 처리
DELETE /api/v1/notifications/:id       // 알림 삭제
PATCH  /api/v1/notifications/read-all  // 전체 읽음
DELETE /api/v1/notifications/clear     // 전체 삭제
```

이벤트 리스너 구현:
```typescript
@OnEvent('order.status.changed')
handleOrderStatusChanged(payload) {
  // 알림 생성
}

@OnEvent('message.received')
handleMessageReceived(payload) {
  // 알림 생성
}

@OnEvent('review.created')
handleReviewCreated(payload) {
  // 알림 생성
}

@OnEvent('product.liked')
handleProductLiked(payload) {
  // 알림 생성
}
```

**Day 4: 알림 템플릿 시스템**

알림 메시지 자동 생성:
```typescript
const templates = {
  ORDER_STATUS_CHANGED: '주문 상태가 {status}로 변경되었습니다.',
  NEW_MESSAGE: '{sender}님으로부터 새 메시지가 도착했습니다.',
  REVIEW_RECEIVED: '{reviewer}님이 리뷰를 작성했습니다.',
  PRODUCT_LIKED: '{user}님이 상품을 찜했습니다.',
};
```

**Day 5: E2E 테스트**

테스트 케이스 (예상 10-12개):
- 알림 자동 생성 (이벤트 통합)
- 알림 조회/필터링
- 읽음 처리
- 권한 검증

---

## 🔧 보완 작업

### Favorites 모듈 개선 (선택적)

**현재 상태**:
- ✅ API 4개 구현 완료
- ❌ E2E 테스트 없음
- ⚠️ 페이지네이션 응답 구조 불일치

**개선 사항**:
1. E2E 테스트 작성 (8-10개 예상)
2. 페이지네이션 응답 구조 통일
   ```typescript
   // 현재: Flat 구조
   { items: [], page, limit, total, totalPage, hasNext }

   // 변경: Meta 구조 (표준)
   { items: [], meta: { page, limit, total, totalPage, hasNext } }
   ```

---

## 📊 Phase 4 진행 현황

### 도메인 완성도 (업데이트)

| 도메인 | API | E2E | 상태 |
|--------|-----|-----|------|
| Users | 6 | 13 | ✅ 완료 |
| Products | 8 | 21 | ✅ 완료 |
| Categories | 5 | 11 | ✅ 완료 |
| Orders | 8 | 17 | ✅ 완료 |
| Auth | - | 15 | ✅ 완료 |
| **Reviews** | **8** | **28** | **✅ 완료 (2025-12-03)** |
| Favorites | 4 | 0 | ⚠️ E2E 테스트 필요 |
| Messages | 0 | 0 | 📝 다음 목표 |
| Notifications | 0 | 0 | 📝 예정 |

### 테스트 현황 (업데이트)

| 시점 | 테스트 수 | 비고 |
|------|----------|------|
| Phase 3 완료 (2025-12-02) | 110개 | AuthModule 리팩토링 |
| **현재 (2025-12-03)** | **138개** | **Reviews 모듈 +28개** |
| Week 12 목표 | 153-161개 | Messages 모듈 추가 시 |
| Week 13 목표 | 163-173개 | Notifications 추가 시 |

**Phase 4 완료 시 목표**: **170개+ 테스트** (현재 진행률: 81%)

---

## 🚀 다음 작업 우선순위

### 1. Messages 모듈 구현 (최우선)

**목표**: 구매자-판매자 1:1 채팅 시스템
**예상 기간**: 3-5일
**비즈니스 가치**: ⭐⭐⭐⭐ (거래 편의성)

**시작 명령**:
```bash
# MongoDB 스키마 설계
vi src/modules/messages/schemas/

# 모듈 구조 생성
mkdir -p src/modules/messages/{dto,schemas,repositories}

# 개발 시작
vi src/modules/messages/messages.module.ts
```

**핵심 구현 사항**:
- MongoDB 기반 대화방/메시지 관리
- HTTP 폴링 또는 WebSocket 선택
- 읽지 않은 메시지 카운트
- 권한 검증 (당사자만 접근)

---

### 2. Favorites E2E 테스트 작성 (선택적)

**목표**: Favorites 모듈 테스트 커버리지 완성
**예상 기간**: 1일
**비즈니스 가치**: ⭐⭐⭐ (품질 개선)

**시작 명령**:
```bash
# E2E 테스트 파일 생성
vi src/modules/favorites/favorites.e2e.spec.ts
```

**예상 테스트 수**: 8-10개
- 즐겨찾기 추가/삭제
- 중복 추가 방지
- 목록 조회 (페이지네이션)
- 권한 검증

---

### 3. Notifications 모듈 구현

**목표**: 통합 알림 시스템
**예상 기간**: 3-5일
**비즈니스 가치**: ⭐⭐⭐⭐ (사용자 경험)

**시작 명령**:
```bash
# Prisma 스키마 수정
vi prisma/schema.prisma

# 마이그레이션 생성
npm run migration:create -- --name add-notifications

# 이벤트 리스너 구현
mkdir -p src/modules/notifications/listeners
```

**핵심 구현 사항**:
- 이벤트 기반 알림 자동 생성
- 읽음/안읽음 상태 관리
- 알림 템플릿 시스템
- 푸시 알림 준비 (선택적)

---

## ⚠️ 주의사항

### 1. ✅ Reviews 모듈 (완료)
- ✅ Order 상태 검증 구현 완료 (CONFIRMED)
- ✅ 중복 리뷰 방지 구현 완료 (orderId unique)
- ✅ 평점 범위 검증 구현 완료 (1-5)
- ✅ 신뢰도 점수 구현 완료 (소수점 2자리)

### 2. Messages 모듈 구현 시 (다음 작업)
- ✅ MongoDB 연결 확인
- ✅ 폴링 vs WebSocket 결정
- ✅ 메시지 삭제 정책 (soft delete vs hard delete)
- ✅ 읽음 처리 동기화

### 3. Notifications 모듈 구현 시
- ✅ 이벤트 중복 처리 방지
- ✅ 알림 보관 기간 정책
- ✅ 알림 수 제한 (성능)
- ✅ 푸시 알림 연동 준비 (선택적)

---

## 📚 참고 문서

1. [개발계획서 2025](./개발계획서_2025_10_24_업데이트.md)
2. [상세 실행 계획서](./3.%20상세_개발_실행_계획서.md)
3. [Prisma 마이그레이션 가이드](./Prisma_마이그레이션_가이드.md)
4. [이벤트 시스템 가이드](./rabbitmq-events-guide.md)

---

## 📝 변경 이력

### v1.1 (2025-12-03)
- ✅ Reviews 모듈 완료 반영
- ✅ 테스트 현황 업데이트 (110 → 138개)
- ✅ Phase 4 진행 현황 갱신
- ✅ 다음 작업 우선순위 재정렬

### v1.0 (2025-12-02)
- 초안 작성
- Phase 4 계획 수립

---

**문서 버전**: v1.1
**최종 업데이트**: 2025-12-03
**다음 업데이트**: Messages 모듈 완료 시
