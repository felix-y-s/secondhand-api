# 개발 계획서: 중고거래사이트 백엔드 API

## 📋 프로젝트 정보

### 기본 정보
- **프로젝트**: 중고거래사이트 백엔드 API
- **기간**: 16주 (4개월)
- **팀 구성**: 백엔드 개발자 2-3명, DevOps 1명
- **기술 스택**: NestJS + Express, PostgreSQL, MongoDB, Redis

### 목표 및 성공 지표
- **비즈니스**: 안전한 중고거래 플랫폼 구축
- **기술**: 99.9% 가용성, API 응답시간 <200ms
- **품질**: 테스트 커버리지 >80%, 사기 발생률 <0.1%

## 🏗️ 시스템 아키텍처 설계

### 전체 아키텍처 (이벤트 기반 + 마이크로서비스 준비)
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Client Apps   │────│  API Gateway    │────│   NestJS API    │
│ (Web/Mobile)    │    │  (Rate Limit)   │    │   Servers       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                       ┌────────────────────────────────┼────────────────┐
                       │                                │                │
                    ┌─────────────────┐        ┌─────────────────┐  ┌─────────────────┐
                    │   Event Bus     │        │   외부 API 연동   │  │  Monitoring     │
                    │  (RabbitMQ)     │        │ (PG사/택배/SMS)  │  │ (Winston/APM)   │
                    └─────────────────┘        └─────────────────┘  └─────────────────┘
                             │                          │                     │
              ┌──────────────┼──────────────┐          │              ┌─────────────────┐
              │              │              │          │              │   Security      │
     ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐      │ (Fraud/2FA)     │
     │   PostgreSQL    │ │    MongoDB      │ │     Redis       │      └─────────────────┘
     │ (구조화 데이터)  │ │ (비구조화 데이터) │ │ (캐시/세션/큐)   │
     │ Master/Replica   │ │   Sharded       │ │   Clustered     │
     └─────────────────┘ └─────────────────┘ └─────────────────┘
```

### 모듈 구조 설계 (이벤트 기반 아키텍처)
```
src/
├── common/               # 공통 모듈
│   ├── guards/          # 인증/인가 가드
│   ├── interceptors/    # 응답 인터셉터
│   ├── decorators/      # 커스텀 데코레이터
│   └── pipes/           # 검증 파이프
├── config/              # 설정 모듈
│   ├── database.config.ts
│   ├── redis.config.ts
│   ├── rabbitmq.config.ts
│   └── app.config.ts
├── database/            # 데이터베이스 모듈
│   ├── postgresql/      # TypeORM 설정
│   ├── mongodb/         # Mongoose 설정
│   ├── redis/           # Redis 설정
│   └── consistency/     # 데이터 일관성 관리
├── events/              # 이벤트 아키텍처 (NEW)
│   ├── handlers/        # 이벤트 핸들러
│   ├── publishers/      # 이벤트 발행
│   ├── subscribers/     # 이벤트 구독
│   └── saga/            # 분산 트랜잭션 Saga
├── queues/              # 메시지 큐 시스템 (NEW)
│   ├── producers/       # 메시지 생산자
│   ├── consumers/       # 메시지 소비자
│   └── processors/      # 작업 처리기
├── integrations/        # 외부 연동 모듈 (NEW)
│   ├── payment/         # PG사 연동
│   ├── shipping/        # 택배사 연동
│   ├── verification/    # 본인인증 연동
│   └── notification/    # SMS/이메일 연동
├── compliance/          # 컴플라이언스 모듈 (NEW)
│   ├── gdpr/           # GDPR 처리
│   ├── pci/            # PCI DSS 준수
│   ├── audit/          # 감사 추적
│   └── privacy/        # 개인정보 처리
├── security/            # 보안 강화 모듈 (NEW)
│   ├── fraud-detection/ # 사기 탐지 AI
│   ├── encryption/     # 암호화 서비스
│   ├── two-factor/     # 2FA 구현
│   └── threat-monitor/ # 위협 모니터링
├── modules/             # 도메인 모듈
│   ├── users/           # 사용자 관리
│   ├── products/        # 상품 관리
│   ├── orders/          # 주문 관리
│   ├── categories/      # 카테고리 관리
│   ├── auth/            # 인증/인가
│   ├── payments/        # 결제 관리
│   ├── shipping/        # 배송 관리
│   ├── notifications/   # 알림 시스템
│   ├── search/          # 검색 엔진
│   ├── reviews/         # 리뷰 시스템
│   └── analytics/       # 데이터 분석
└── shared/              # 공유 유틸리티
    ├── utils/
    ├── constants/
    ├── types/
    └── patterns/        # 아키텍처 패턴
```

## 📅 상세 개발 일정

### Phase 1: 기반 인프라 구축 (4주)

#### Week 1: 프로젝트 초기 설정 + 이벤트 아키텍처
**목표**: 개발 환경 구축 및 이벤트 기반 아키텍처 기반 설정

**상세 작업**:
1. **패키지 설치 및 설정** (3일)
   ```bash
   # 데이터베이스
   npm install @nestjs/typeorm typeorm pg @types/pg
   npm install @nestjs/mongoose mongoose @types/mongoose
   npm install @nestjs/redis redis @types/redis
   
   # 이벤트 & 메시지 큐
   npm install @nestjs/microservices amqplib @types/amqplib
   npm install @nestjs/event-emitter @nestjs/cqrs
   
   # 보안 & 검증
   npm install @nestjs/config class-validator class-transformer
   npm install @nestjs/jwt @nestjs/passport passport-jwt
   npm install @nestjs/throttler helmet bcrypt
   
   # 외부 연동
   npm install axios @nestjs/axios
   ```

2. **Docker 환경 구성** (1일)
   - `docker-compose.yml` 작성 (PostgreSQL, MongoDB, Redis, RabbitMQ)
   - `Dockerfile` 작성
   - `.env` 환경 변수 설정

3. **이벤트 아키텍처 기반 구조** (1일)
   - Event Sourcing 기반 폴더 구조
   - CQRS 패턴 준비
   - Saga 패턴 기반 구조

**산출물**: 
- Docker 환경
- 기본 프로젝트 구조
- 환경 설정 파일

#### Week 2: 데이터 일관성 전략 + DB 설계
**목표**: 하이브리드 DB 동기화 전략 수립 및 스키마 설계

**상세 작업**:
1. **데이터 일관성 전략 설계** (2일)
   ```typescript
   // Event Sourcing + CQRS 패턴
   - Command: PostgreSQL (트랜잭션 보장)
   - Query: MongoDB (검색 최적화)
   - Event Store: 이벤트 기록 저장소
   - Projection: MongoDB 뷰 자동 업데이트
   ```

2. **PostgreSQL 스키마 설계** (1일)
   ```sql
   -- 핵심 트랜잭션 데이터
   Users, Roles, UserRoles
   Orders, OrderItems, Payments
   ProductInventory, Transactions
   EventStore (이벤트 저장)
   ```

3. **MongoDB 스키마 설계** (1일)
   ```javascript
   // 읽기 최적화 컬렉션
   ProductCatalog, ProductDetails
   Reviews, Messages, SearchHistory
   UserProfiles, ActivityLogs
   ```

4. **데이터 동기화 메커니즘** (1일)
   - Event Handler 구현
   - Saga 패턴 트랜잭션
   - 실패 복구 전략

**산출물**:
- 데이터베이스 스키마 문서
- Entity 클래스들
- 마이그레이션 파일

#### Week 3: 이벤트 시스템 + 외부 연동 모듈
**목표**: 이벤트 기반 아키텍처 구현 및 외부 연동 준비

**상세 작업**:
1. **이벤트 시스템 구현** (2일)
   - EventEmitter, CQRS 설정
   - Event Bus (RabbitMQ) 연결
   - Event Store 구현

2. **외부 연동 모듈 기반 구조** (2일)
   - Payment Gateway 인터페이스
   - 택배사 API 추상화
   - SMS/이메일 서비스 래퍼

3. **데이터 일관성 핸들러** (1일)
   - PostgreSQL → MongoDB 동기화
   - Event Replay 메커니즘
   - 실패 복구 로직

**산출물**:
- 설정 모듈
- 데이터베이스 연결 모듈
- 공통 유틸리티

#### Week 4: 보안 & 컴플라이언스 기반 구조
**목표**: 보안 강화 및 컴플라이언스 준수 기반 구축

**상세 작업**:
1. **보안 모듈 구현** (2일)
   - 2FA 시스템 기반 구조
   - 암호화 서비스 (AES-256)
   - 사기 탐지 AI 모델 준비

2. **컴플라이언스 모듈** (2일)
   - GDPR 데이터 처리 모듈
   - PCI DSS 준수 설정
   - 감사 추적 시스템

3. **CI/CD 및 테스트 환경** (1일)
   - GitHub Actions (보안 스캔 포함)
   - Jest 테스트 환경
   - Docker 보안 설정

**산출물**:
- CI/CD 파이프라인
- 테스트 환경
- 개발 도구 설정

### Phase 2: 핵심 기능 개발 (6주)

#### Week 5-6: 사용자 인증/인가 + 컴플라이언스 시스템
**목표**: 완전한 사용자 관리 시스템 + 보안 컴플라이언스

**Week 5 작업**:
1. **사용자 모듈 + GDPR 준수** (3일)
   - User Entity (PostgreSQL) + 개인정보 암호화
   - UserProfile Schema (MongoDB) + 동의 관리
   - GDPR 데이터 처리 로직 (삭제권, 이동권)

2. **JWT + 2FA 인증 시스템** (2일)
   - JWT 모듈 설정 + 보안 강화
   - 2FA 구현 (TOTP, SMS)
   - Refresh Token + 세션 관리

**Week 6 작업**:
1. **권한 관리 + PCI DSS** (3일)
   - Role-based 권한 + 최소 권한 원칙
   - PCI DSS 준수 설정
   - 결제 데이터 암호화

2. **소셜 로그인 + 본인인증** (2일)
   - OAuth 2.0 연동 (카카오/구글)
   - NICE/KCB 본인인증 연동
   - 계정 연동 + 신뢰도 시스템

**산출물**:
- 완전한 인증/인가 시스템
- 사용자 API 엔드포인트
- 소셜 로그인 기능

#### Week 7-8: 상품 관리 + 이벤트 소싱 시스템
**목표**: 상품 CRUD + 데이터 일관성 보장

**Week 7 작업**:
1. **상품 이벤트 소싱 구조** (3일)
   - Product Commands (PostgreSQL)
   - Product Events (Event Store)
   - Product Projections (MongoDB)
   - 데이터 동기화 핸들러

2. **파일 업로드 + CDN** (2일)
   - AWS S3 연동
   - CloudFront CDN 설정
   - 이미지 최적화 큐

**Week 8 작업**:
1. **상품 CRUD + 일관성 보장** (3일)
   - Command/Query 분리 API
   - 재고 동시성 제어
   - 이벤트 기반 상태 관리

2. **Elasticsearch 검색** (2일)
   - 상품 인덱싱 자동화
   - 실시간 검색 API
   - 필터링 + 정렬 최적화

**산출물**:
- 이벤트 기반 상품 관리 API
- CDN 연동 파일 업로드
- Elasticsearch 기반 검색

#### Week 9-10: 주문/결제 + Saga 트랜잭션
**목표**: 분산 트랜잭션 기반 거래 프로세스

**Week 9 작업**:
1. **Saga 패턴 주문 시스템** (3일)
   - Order Saga 워크플로우
   - 분산 트랜잭션 관리
   - 보상 트랜잭션 (Compensating)

2. **이벤트 기반 재고 관리** (2일)
   - 재고 이벤트 스트림
   - 동시성 제어 (Optimistic Lock)
   - 재고 부족 이벤트 처리

**Week 10 작업**:
1. **PG사 연동 + 결제 Saga** (3일)
   - 토스페이먼츠/KG이니시스 연동
   - 결제 Saga 워크플로우
   - 결제 실패시 보상 로직

2. **거래 추적성 + Audit Trail** (2일)
   - 모든 거래 이벤트 기록
   - 감사 추적 시스템
   - 분쟁 해결 증거 보전

**산출물**:
- 주문 관리 시스템
- 결제 시스템 기반
- 거래 무결성 보장

### Phase 3: 고급 기능 개발 (4주)

#### Week 11: 검색 엔진 & 추천 시스템
**목표**: Elasticsearch 연동 및 추천 알고리즘

**상세 작업**:
1. **Elasticsearch 연동** (3일)
   - ES 설정 및 인덱스 설계
   - 상품 데이터 동기화
   - 전문검색 API

2. **추천 시스템 기반** (2일)
   - 협업 필터링 알고리즘
   - 상품 추천 API
   - 개인화 추천

**산출물**:
- 고성능 검색 시스템
- 기본 추천 엔진

#### Week 12: 실시간 커뮤니케이션
**목표**: 채팅 및 알림 시스템

**상세 작업**:
1. **WebSocket 채팅** (3일)
   - Socket.IO 설정
   - 실시간 메시지
   - 채팅 히스토리 (MongoDB)

2. **알림 시스템** (2일)
   - 푸시 알림 서비스
   - 이메일/SMS 연동
   - 알림 설정 관리

**산출물**:
- 실시간 채팅 시스템
- 알림 인프라

#### Week 13: 보안 강화
**목표**: 보안 정책 구현 및 사기 방지

**상세 작업**:
1. **보안 미들웨어** (2일)
   - Rate Limiting
   - CORS, Helmet
   - 입력 검증 강화

2. **사기 탐지 시스템** (3일)
   - 이상 패턴 감지
   - 위험도 스코어링
   - 자동 차단 로직

**산출물**:
- 보안 정책 구현
- 사기 방지 시스템

#### Week 14: 성능 최적화
**목표**: 캐싱 및 성능 튜닝

**상세 작업**:
1. **Redis 캐싱 전략** (2일)
   - 인기 상품 캐시
   - 검색 결과 캐시
   - 세션 관리

2. **데이터베이스 최적화** (3일)
   - 인덱스 최적화
   - 쿼리 성능 튜닝
   - 연결 풀 관리

**산출물**:
- 캐싱 시스템
- 성능 최적화

### Phase 4: 배포 및 운영 준비 (2주)

#### Week 15: 모니터링 및 문서화
**목표**: 운영 모니터링 시스템

**상세 작업**:
1. **모니터링 시스템** (3일)
   - Winston 로깅
   - 헬스체크 API
   - 메트릭 수집

2. **API 문서화** (2일)
   - Swagger 설정
   - API 명세서 작성
   - Postman 컬렉션

**산출물**:
- 모니터링 대시보드
- API 문서

#### Week 16: 프로덕션 배포
**목표**: 프로덕션 환경 배포

**상세 작업**:
1. **배포 준비** (2일)
   - 프로덕션 설정
   - 보안 설정 점검
   - 성능 테스트

2. **배포 및 검증** (3일)
   - 프로덕션 배포
   - 시스템 검증
   - 부하 테스트

**산출물**:
- 프로덕션 시스템
- 운영 가이드

## 🔧 기술 구현 상세

### 데이터베이스 설계

#### PostgreSQL 스키마
```sql
-- 사용자 관리
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT
);

CREATE TABLE user_roles (
    user_id INTEGER REFERENCES users(id),
    role_id INTEGER REFERENCES roles(id),
    PRIMARY KEY (user_id, role_id)
);

-- 상품 기본 정보
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id INTEGER REFERENCES categories(id),
    level INTEGER NOT NULL,
    path VARCHAR(500)
);

CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    seller_id INTEGER REFERENCES users(id),
    category_id INTEGER REFERENCES categories(id),
    title VARCHAR(255) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    stock_quantity INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 주문 관리
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    buyer_id INTEGER REFERENCES users(id),
    seller_id INTEGER REFERENCES users(id),
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id),
    product_id INTEGER REFERENCES products(id),
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL
);

-- 결제 관리
CREATE TABLE payments (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id),
    payment_method VARCHAR(50),
    amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    transaction_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### MongoDB 스키마
```javascript
// 상품 상세 정보
const ProductDetailSchema = {
  productId: { type: Number, required: true, unique: true },
  description: { type: String, required: true },
  images: [{ 
    url: String, 
    alt: String, 
    order: Number 
  }],
  specifications: {
    brand: String,
    condition: String,
    location: {
      city: String,
      district: String,
      coordinates: [Number] // [lng, lat]
    }
  },
  metadata: {
    views: { type: Number, default: 0 },
    likes: { type: Number, default: 0 },
    tags: [String]
  },
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now }
};

// 리뷰 시스템
const ReviewSchema = {
  orderId: { type: Number, required: true },
  reviewerId: { type: Number, required: true },
  revieweeId: { type: Number, required: true },
  rating: { type: Number, min: 1, max: 5, required: true },
  comment: String,
  images: [String],
  createdAt: { type: Date, default: Date.now }
};

// 메시지 시스템
const MessageSchema = {
  conversationId: String,
  senderId: { type: Number, required: true },
  receiverId: { type: Number, required: true },
  message: { type: String, required: true },
  messageType: { type: String, enum: ['text', 'image', 'system'], default: 'text' },
  readAt: Date,
  createdAt: { type: Date, default: Date.now }
};
```

### API 설계

#### 인증 API
```typescript
// 인증 엔드포인트
POST /auth/register      // 회원가입
POST /auth/login         // 로그인
POST /auth/refresh       // 토큰 갱신
POST /auth/logout        // 로그아웃
POST /auth/verify-email  // 이메일 인증
POST /auth/reset-password // 비밀번호 재설정

// 소셜 로그인
GET  /auth/kakao         // 카카오 로그인
GET  /auth/google        // 구글 로그인
POST /auth/social/callback // 소셜 로그인 콜백
```

#### 사용자 API
```typescript
GET    /users/profile     // 프로필 조회
PUT    /users/profile     // 프로필 수정
GET    /users/:id/reviews // 사용자 리뷰
GET    /users/:id/trust   // 신뢰도 조회
POST   /users/verify      // 본인 인증
```

#### 상품 API
```typescript
GET    /products          // 상품 목록 (페이지네이션, 필터)
POST   /products          // 상품 등록
GET    /products/:id      // 상품 상세 조회
PUT    /products/:id      // 상품 수정
DELETE /products/:id      // 상품 삭제
POST   /products/:id/images // 이미지 업로드
GET    /products/categories // 카테고리 목록
```

#### 주문 API
```typescript
POST   /orders           // 주문 생성
GET    /orders           // 주문 목록
GET    /orders/:id       // 주문 상세
PUT    /orders/:id/status // 주문 상태 변경
POST   /orders/:id/cancel // 주문 취소
```

## 📊 성능 목표 및 모니터링

### 성능 지표
- **응답 시간**: 평균 <200ms, 95th percentile <500ms
- **처리량**: 1,000 동시 사용자, 일 10,000 거래
- **가용성**: 99.9% 업타임
- **에러율**: <0.1%

### 모니터링 메트릭
```typescript
// 핵심 모니터링 지표
interface PerformanceMetrics {
  responseTime: {
    avg: number;      // 평균 응답시간
    p95: number;      // 95th percentile
    p99: number;      // 99th percentile
  };
  throughput: {
    rps: number;      // Requests per second
    concurrent: number; // 동시 사용자
  };
  errors: {
    rate: number;     // 에러율
    count: number;    // 에러 수
  };
  database: {
    connections: number; // DB 연결 수
    queryTime: number;   // 쿼리 시간
  };
}
```

## 🔒 보안 구현 계획

### 인증/인가 보안
```typescript
// JWT 설정
{
  secret: process.env.JWT_SECRET,
  signOptions: { 
    expiresIn: '1h',
    algorithm: 'HS256'
  },
  refreshOptions: {
    expiresIn: '7d'
  }
}

// Rate Limiting
@ThrottlerGuard({
  default: {
    limit: 100,    // 100 requests
    ttl: 60000     // per minute
  }
})
```

### 데이터 보안
```typescript
// 개인정보 암호화
class EncryptionService {
  private readonly algorithm = 'aes-256-gcm';
  
  encrypt(text: string): string {
    // AES-256-GCM 암호화 구현
  }
  
  decrypt(encryptedData: string): string {
    // 복호화 구현
  }
}

// 입력 검증
class CreateUserDto {
  @IsEmail()
  @IsNotEmpty()
  email: string;
  
  @IsString()
  @MinLength(8)
  @Matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
  password: string;
}
```

## 🧪 테스트 계획

### 테스트 전략
- **단위 테스트**: >80% 커버리지
- **통합 테스트**: API 엔드포인트 전체
- **E2E 테스트**: 핵심 사용자 시나리오
- **성능 테스트**: 부하 테스트, 스트레스 테스트

### 테스트 시나리오
```typescript
// 핵심 테스트 케이스
describe('중고거래 시스템 E2E', () => {
  it('사용자 회원가입 → 로그인 → 상품등록 → 주문 → 결제', async () => {
    // 전체 거래 플로우 테스트
  });
  
  it('동시 주문 시 재고 일관성 보장', async () => {
    // 동시성 테스트
  });
  
  it('사기 패턴 감지 및 차단', async () => {
    // 보안 테스트
  });
});
```

## 🏗️ 마이크로서비스 전환 준비

### 서비스 분리 전략
```yaml
모놀리식 → 마이크로서비스 단계적 전환:

Phase 1 (모놀리식): 단일 NestJS 앱
Phase 2 (모듈형): 도메인별 모듈 완전 분리
Phase 3 (마이크로서비스): 독립 서비스 분리

예상 분리 서비스:
- user-service: 사용자 관리 + 인증
- product-service: 상품 관리 + 검색
- order-service: 주문 + 결제
- notification-service: 알림 + 커뮤니케이션
- fraud-service: 사기 탐지 + 보안
```

### API Gateway 패턴
```yaml
Kong/Nginx Gateway:
- 라우팅: 서비스별 트래픽 분산
- 인증: JWT 중앙 검증
- Rate Limiting: 서비스별 제한
- 로드밸런싱: 헬스체크 기반
```

## 📦 배포 계획

### 배포 환경
- **개발**: Docker Compose (로컬)
- **스테이징**: AWS ECS (테스트)
- **프로덕션**: AWS EKS (쿠버네티스) + 마이크로서비스 준비

### 배포 전략
```yaml
# docker-compose.yml (업데이트된 이벤트 기반 아키텍처)
version: '3.8'
services:
  api:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      - postgres
      - mongodb
      - redis
      - rabbitmq
      - elasticsearch
  
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_DB: secondhand_db
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # 읽기 복제본 준비
    
  postgres-replica:
    image: postgres:14-alpine
    environment:
      POSTGRES_DB: secondhand_db
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    command: |
      postgres -c wal_level=replica -c max_wal_senders=3 -c max_replication_slots=3
  
  mongodb:
    image: mongo:6-alpine
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    volumes:
      - mongodb_data:/data/db
    # 샤딩 준비 구성
  
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
  
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "15672:15672"  # 관리 UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
  
  elasticsearch:
    image: elasticsearch:8.11-alpine
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
  
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - api

volumes:
  postgres_data:
  mongodb_data:
  redis_data:
  rabbitmq_data:
  elasticsearch_data:
```

## 📋 위험 관리 및 대응

### 기술적 위험 (업데이트)
1. **하이브리드 DB 일관성**: Event Sourcing 실패시 데이터 불일치
   - 대응: Event Replay 메커니즘, 수동 복구 프로세스
2. **이벤트 스트림 장애**: RabbitMQ 다운시 시스템 마비
   - 대응: Dead Letter Queue, 장애 복구 자동화
3. **외부 연동 의존성**: PG사/택배사 API 장애
   - 대응: Circuit Breaker, 다중 PG사 지원
4. **성능 병목**: 대용량 이벤트 처리
   - 대응: 샤딩, 읽기 복제본, 캐싱 전략
5. **보안 컴플라이언스**: GDPR/PCI DSS 위반 위험
   - 대응: 정기 감사, 자동 컴플라이언스 체크

### 비즈니스 위험
1. **사기 거래**: AI 기반 실시간 감지
2. **법적 리스크**: 법무팀 검토, 규정 준수
3. **확장성**: 마이크로서비스 마이그레이션 준비

### 대응 방안
- **모니터링 알림**: 임계값 초과시 즉시 알림
- **자동 복구**: 장애 감지시 자동 재시작
- **백업 전략**: 일 2회 자동 백업, 실시간 복제

## 📈 성공 기준 및 검증

### 기능 검증
- [ ] 모든 API 엔드포인트 정상 동작
- [ ] 결제 플로우 완전 동작
- [ ] 보안 정책 적용 완료
- [ ] 성능 목표 달성

### 품질 검증
- [ ] 테스트 커버리지 >80%
- [ ] 보안 감사 통과
- [ ] 성능 테스트 통과
- [ ] 코드 리뷰 완료

### 운영 준비
- [ ] 모니터링 시스템 구축
- [ ] 배포 파이프라인 구축
- [ ] 문서 작성 완료
- [ ] 팀 교육 완료

## 🔄 다음 단계

1. **즉시 시작**: Phase 1 - Docker 환경 구축
2. **1주차 목표**: 기본 패키지 설치 및 데이터베이스 연결
3. **우선순위**: 사용자 인증 → 상품 관리 → 주문 시스템

---

**문서 버전**: v1.0  
**작성일**: 2025-08-31  
**검토 필요**: 기술팀, PM, 보안팀  
**승인 후**: Phase 1 개발 시작